<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<link rel="apple-touch-icon" sizes="512x512" href="icon-512.png">
<link rel="icon" href="icon-512.png">
  <title>Study Quest (Tabs + Study log)</title>

  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Study Quest">
  <meta name="theme-color" content="#fff6fb">
  <meta name="format-detection" content="telephone=no">

  <style>
    :root{
      --bg1:#fff6fb; --bg2:#f1fbff;
      --card:#ffffff; --text:#2a2a36; --muted:#6b6b86;
      --accent:#ff77b7; --accent2:#76d6ff; --accent3:#a6ffb8; --accent4:#ffd56a;
      --line:#e9e4ff; --shadow: 0 12px 26px rgba(36, 20, 80, .12);
      --radius:18px; --radius2:22px;
      --navH:80px;
    }

    *{ box-sizing:border-box; }

    body{
      margin:0; color:var(--text);
      font-family:-apple-system,BlinkMacSystemFont,"Hiragino Sans","Noto Sans JP","Helvetica Neue",sans-serif;
      background:
        radial-gradient(1200px 700px at 20% 10%, rgba(255,119,183,.20), transparent 60%),
        radial-gradient(1100px 650px at 85% 20%, rgba(118,214,255,.20), transparent 58%),
        radial-gradient(900px 600px at 50% 90%, rgba(166,255,184,.22), transparent 55%),
        linear-gradient(180deg, var(--bg1), var(--bg2));
      padding-bottom: calc(var(--navH) + env(safe-area-inset-bottom) + 18px);
    }

    #app{ max-width:860px; margin:0 auto; padding:18px; padding-top: calc(18px + env(safe-area-inset-top)); padding-bottom: calc(var(--navH) + 18px); }
    h1{
      font-size:20px; margin:6px 0 14px;
      display:flex; align-items:center; gap:8px;
    }
    .row{ display:grid; gap:12px; }

    .card{
      background: var(--card);
      border: 2px solid var(--line);
      border-radius: var(--radius2);
      padding: 14px;
      box-shadow: var(--shadow);
      position: relative;
      overflow:hidden;
    }
    .card::before{
      content:"";
      position:absolute; inset:-2px;
      background:
        radial-gradient(120px 80px at 15% 10%, rgba(255,119,183,.18), transparent 60%),
        radial-gradient(130px 90px at 85% 15%, rgba(118,214,255,.18), transparent 60%),
        radial-gradient(160px 120px at 70% 110%, rgba(166,255,184,.18), transparent 60%);
      pointer-events:none;
    }
    .card::after{
      content:"";
      position:absolute;
      right:12px; top:12px;
      width:10px; height:10px; border-radius:999px;
      background: rgba(0,0,0,.08);
      box-shadow:-24px 0 0 rgba(0,0,0,.06), 0 24px 0 rgba(0,0,0,.06), -24px 24px 0 rgba(0,0,0,.05);
      pointer-events:none;
    }
    .card > *{ position: relative; z-index:1; }

    .muted{ color:var(--muted); font-size:13px; }

    .stats{
      display:grid;
      grid-template-columns:repeat(4,1fr);
      gap:10px;
    }
    .stat{
      padding:10px;
      border-radius: var(--radius);
      background: linear-gradient(180deg, #ffffff, #fff9ff);
      border:2px solid var(--line);
      box-shadow: 0 8px 18px rgba(30,20,70,.08);
    }
    .stat b{ display:block; font-size:18px; margin-top:4px; }

    /* mini stats on HOME top */
    .miniStats{
      display:grid;
      grid-template-columns:repeat(3,1fr);
      gap:10px;
    }
    .miniStat{
      padding:10px;
      border-radius: var(--radius);
      border:2px solid var(--line);
      background: linear-gradient(180deg, #fff, #fff7fb);
      box-shadow: 0 8px 18px rgba(30,20,70,.06);
    }
    .miniStat .label{ font-size:12px; color:var(--muted); font-weight:800; letter-spacing:.2px; }
    .miniStat .value{
      margin-top:4px;
      font-size:18px;
      font-weight:950;
      font-variant-numeric: tabular-nums;
      color:#1f1430;
    }
    .miniStat .sub{ margin-top:2px; font-size:12px; color:var(--muted); }

    button{
      width:100%;
      border:0;
      border-radius: 999px;
      padding:12px 14px;
      font-size:15px;
      font-weight:800;
      cursor:pointer;
      color:#1f1430;
      background: linear-gradient(180deg, #ffd0e7, #ff77b7);
      box-shadow: 0 10px 0 rgba(255,119,183,.25), 0 12px 22px rgba(40,20,80,.12);
      transform: translateY(0);
      transition: transform .06s ease, filter .15s ease, opacity .15s ease;
    }
    button:hover{ filter: brightness(1.02); }
    button:active{
      transform: translateY(2px);
      box-shadow: 0 8px 0 rgba(255,119,183,.22), 0 10px 16px rgba(40,20,80,.10);
    }
    button:disabled{ opacity:.55; cursor:not-allowed; transform:none; }

    button.secondary{
      color:#143044;
      background: linear-gradient(180deg, #d7f4ff, #76d6ff);
      box-shadow: 0 10px 0 rgba(118,214,255,.25), 0 12px 22px rgba(40,20,80,.10);
    }
    button.secondary:active{
      transform: translateY(2px);
      box-shadow: 0 8px 0 rgba(118,214,255,.22), 0 10px 16px rgba(40,20,80,.08);
    }

    button.danger{
      color:#3a1022;
      background: linear-gradient(180deg, #ffe0ea, #ff9dbb);
      box-shadow: 0 10px 0 rgba(255,157,187,.25), 0 12px 22px rgba(40,20,80,.10);
      border:2px solid rgba(255,157,187,.45);
    }
    button.danger:active{
      transform: translateY(2px);
      box-shadow: 0 8px 0 rgba(255,157,187,.22), 0 10px 16px rgba(40,20,80,.08);
    }

    select,input{
      width:100%;
      padding:10px 12px;
      border-radius: 999px;
      border:2px solid var(--line);
      background: #ffffff;
      color:var(--text);
      font-size:14px;
      box-shadow: 0 8px 18px rgba(30,20,70,.06);
      outline:none;
    }
    select:focus,input:focus{
      border-color: rgba(255,119,183,.55);
      box-shadow: 0 0 0 6px rgba(255,119,183,.18), 0 8px 18px rgba(30,20,70,.06);
    }

    .two{ display:grid; grid-template-columns:1fr 1fr; gap:10px; }

    /* --- Screen frame --- */
    .screen-frame{
      margin:10px 0 12px;
      padding:14px;
      border-radius: 28px;
      border:2px solid rgba(0,0,0,.06);
      background:
        radial-gradient(220px 120px at 20% 20%, rgba(255,119,183,.14), transparent 60%),
        radial-gradient(220px 120px at 80% 25%, rgba(118,214,255,.14), transparent 60%),
        linear-gradient(180deg, #fff, #fff7fb);
      box-shadow:
        inset 0 2px 0 rgba(255,255,255,.9),
        inset 0 -8px 16px rgba(30,20,70,.06),
        0 10px 22px rgba(40,20,80,.10);
      position: relative;
      overflow: hidden;
    }
    .screen-frame::before{
      content:"";
      position:absolute; inset:10px;
      border-radius: 22px;
      border:2px dashed rgba(255,119,183,.40);
      pointer-events:none;
      opacity:.8;
    }
    .screen-frame::after{
      content:"";
      position:absolute;
      left:14px; top:10px;
      width:140px; height:44px;
      border-radius: 999px;
      background: rgba(255,255,255,.55);
      transform: rotate(-8deg);
      opacity:.55;
      pointer-events:none;
    }

    #timer{
      font-variant-numeric: tabular-nums;
      font-size:46px;
      font-weight:900;
      letter-spacing:1px;
      text-align:center;
      padding:12px 12px;
      border-radius: 20px;
      border:2px solid rgba(0,0,0,.06);
      background:
        radial-gradient(180px 90px at 30% 40%, rgba(255,119,183,.10), transparent 70%),
        radial-gradient(200px 90px at 70% 40%, rgba(118,214,255,.10), transparent 70%),
        linear-gradient(180deg, #f7fff9, #f2fffb);
      box-shadow:
        inset 0 2px 0 rgba(255,255,255,.9),
        inset 0 -10px 16px rgba(30,20,70,.06);
    }

    .log{ max-height:180px; overflow:auto; padding-right:6px; }
    .pill{
      display:inline-block;
      padding:4px 10px;
      border-radius:999px;
      background: linear-gradient(180deg, #fff, #fff4fb);
      border:2px solid var(--line);
      font-size:12px;
      margin-right:6px;
    }

    .reward{
      border-left: 6px solid var(--accent);
      padding:10px 12px;
      border-radius: var(--radius);
      background: linear-gradient(180deg, #fff, #fff4fb);
      border:2px solid var(--line);
      margin:10px 0;
    }
    .small{ font-size:12px; color:var(--muted); }

    /* --- Panels (Area/Title) --- */
    .panel{
      position: relative;
      border-radius: var(--radius2);
      padding: 12px;
      border:2px solid var(--line);
      box-shadow: 0 10px 20px rgba(30,20,70,.08);
      overflow: hidden;
      min-height: 90px;
    }
    .panel-icon{
      position:absolute;
      right:-10px; bottom:-12px;
      width:96px; height:96px;
      opacity:.22;
      transform: rotate(-10deg);
      pointer-events:none;
      display:flex;
      align-items:flex-end;
      justify-content:flex-end;
      font-size:68px;
      padding:8px;
      user-select:none;
    }
    .panel::after{
      content:"";
      position:absolute; inset:0;
      background-image: radial-gradient(rgba(0,0,0,.06) 1px, transparent 1px);
      background-size: 16px 16px;
      opacity:.18;
      pointer-events:none;
    }

    .area-panel.town{ background:
      radial-gradient(160px 110px at 22% 28%, rgba(255,213,106,.28), transparent 60%),
      radial-gradient(170px 120px at 85% 40%, rgba(118,214,255,.22), transparent 60%),
      linear-gradient(180deg, #fff, #fff8ee);
    }
    .area-panel.forest{ background:
      radial-gradient(160px 110px at 22% 28%, rgba(166,255,184,.30), transparent 60%),
      radial-gradient(170px 120px at 85% 40%, rgba(118,214,255,.18), transparent 60%),
      linear-gradient(180deg, #fff, #f3fff7);
    }
    .area-panel.cave{ background:
      radial-gradient(160px 110px at 22% 28%, rgba(118,214,255,.22), transparent 60%),
      radial-gradient(170px 120px at 85% 40%, rgba(143,124,255,.18), transparent 60%),
      linear-gradient(180deg, #fff, #f4f6ff);
    }
    .area-panel.tower{ background:
      radial-gradient(160px 110px at 22% 28%, rgba(255,119,183,.22), transparent 60%),
      radial-gradient(170px 120px at 85% 40%, rgba(255,213,106,.18), transparent 60%),
      linear-gradient(180deg, #fff, #fff4fb);
    }
    .area-panel.castle{ background:
      radial-gradient(160px 110px at 22% 28%, rgba(255,213,106,.30), transparent 60%),
      radial-gradient(170px 120px at 85% 40%, rgba(255,119,183,.18), transparent 60%),
      linear-gradient(180deg, #fff, #fff9f0);
    }
    .title-panel{
      background:
        radial-gradient(170px 120px at 25% 35%, rgba(143,124,255,.20), transparent 62%),
        radial-gradient(160px 120px at 85% 35%, rgba(255,119,183,.18), transparent 62%),
        linear-gradient(180deg, #fff, #f7f3ff);
    }

    /* --- Study log chart --- */
    .chart-wrap{
      border-radius: var(--radius2);
      border:2px solid var(--line);
      background: linear-gradient(180deg, #fff, #fff7fb);
      box-shadow: 0 10px 20px rgba(30,20,70,.08);
      padding:10px;
      overflow:hidden;
    }
    canvas{ width:100%; display:block; }

    .weekbox{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      align-items:end;
    }
    .kpi{
      border-radius: var(--radius);
      border:2px solid var(--line);
      background: linear-gradient(180deg, #fff, #f7f3ff);
      padding:10px;
      box-shadow: 0 8px 18px rgba(30,20,70,.06);
    }

    .legend{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:8px;
      margin-top:10px;
    }
    .leg{
      display:flex; align-items:center; gap:8px;
      font-size:13px; color:var(--muted);
      border:2px solid var(--line);
      border-radius:999px;
      padding:6px 10px;
      background:linear-gradient(180deg,#fff,#fff7fb);
    }
    .dot{
      width:10px; height:10px;
      border-radius:999px;
      border:1px solid rgba(0,0,0,.08);
    }

    /* --- Pages --- */
    .page{ display:none; }
    .page.active{ display:block; }

    /* --- Bottom nav --- */
    .nav{
      position: fixed;
      left: 0; right: 0; bottom: 0;
      min-height: var(--navH);
      height: var(--navH);
      padding: 10px 12px calc(10px + env(safe-area-inset-bottom));
      background: rgba(255,255,255,.74);
      backdrop-filter: blur(12px);
      border-top: 2px solid var(--line);
      box-shadow: 0 -10px 30px rgba(40,20,80,.10);
      z-index: 999;
    }
    .nav-inner{
      max-width:860px; margin:0 auto;
      display:grid; grid-template-columns: repeat(5,1fr);
      gap:8px;
      align-items:center;
    }
    .navbtn{
      border:2px solid var(--line);
      background: linear-gradient(180deg, #fff, #fff7fb);
      box-shadow: 0 10px 18px rgba(40,20,80,.08);
      border-radius: 999px;
      padding: 0;
      height: 52px;
      width: 100%;
      cursor:pointer;
      user-select:none;
      display:flex; align-items:center; justify-content:center;
      font-size: 24px;
      line-height: 1;
      font-weight:900;
      color: rgba(0,0,0,.70);
    }
    .navbtn.active{
      color:#1f1430;
      border-color: rgba(255,119,183,.55);
      box-shadow: 0 0 0 6px rgba(255,119,183,.16), 0 10px 18px rgba(40,20,80,.08);
      background: linear-gradient(180deg, #ffd0e7, #fff);
    }
    .navbtn:active{ transform: scale(0.98); }
  
    .homeMiniRow{
      display:flex; gap:8px; flex-wrap:wrap;
      align-items:center;
      margin: 2px 0 10px;
    }
    .homeMiniRow .chip{
      display:flex; align-items:baseline; gap:6px;
      padding:6px 10px;
      border-radius:999px;
      border:2px solid var(--line);
      background: rgba(255,255,255,.72);
      box-shadow: 0 8px 14px rgba(40,20,80,.06);
      font-size:12px;
      color: rgba(0,0,0,.62);
      font-weight:800;
    }
    .homeMiniRow .chip b{ font-size:13px; color: rgba(0,0,0,.78); }

  
    /* --- Tamagotchi-ish polish --- */
    :root{
      --pink:#ff77b7;
      --mint:#35d6c6;
      --sun:#ffd86b;
      --vio:#8f7cff;
      --ink: rgba(0,0,0,.72);
    }
    body{
      background:
        radial-gradient(900px 520px at 15% -10%, rgba(255,119,183,.22), transparent 60%),
        radial-gradient(900px 520px at 85% -10%, rgba(53,214,198,.22), transparent 60%),
        radial-gradient(900px 520px at 50% 120%, rgba(143,124,255,.18), transparent 60%),
        var(--bg);
    }
    h1{
      display:flex; align-items:center; gap:10px;
      font-size:20px;
      padding:10px 12px;
      margin:0 0 12px;
      border:3px solid var(--line);
      border-radius:16px;
      background: linear-gradient(180deg, rgba(255,255,255,.92), rgba(255,255,255,.78));
      box-shadow: 0 14px 22px rgba(40,20,80,.08);
    }
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.90), rgba(255,255,255,.76));
      border:3px solid var(--line);
      box-shadow: 0 18px 28px rgba(40,20,80,.10);
    }
    .stat{
      border:2px solid var(--line);
      background: linear-gradient(180deg, rgba(255,255,255,.86), rgba(255,255,255,.70));
      box-shadow: 0 10px 16px rgba(40,20,80,.07);
    }
    button{
      border:3px solid rgba(0,0,0,.10);
      background: linear-gradient(180deg, #fff, #ffe8f4);
      box-shadow: 0 12px 18px rgba(40,20,80,.10);
      color: var(--ink);
    }
    button.secondary{
      background: linear-gradient(180deg, #fff, #eefcff);
    }
    button.danger{
      background: linear-gradient(180deg, #ffe4ea, #fff);
      border-color: rgba(255,90,120,.35);
      color:#8a1b33;
    }
    button:active{ transform: scale(0.98); }
    select,input{
      border:3px solid rgba(0,0,0,.08);
      background: rgba(255,255,255,.80);
      box-shadow: 0 10px 16px rgba(40,20,80,.06);
      color: rgba(0,0,0,.78);
    }
    .pill{
      border:2px solid var(--line);
      background: rgba(255,255,255,.78);
      box-shadow: 0 8px 12px rgba(40,20,80,.06);
      color: rgba(0,0,0,.62);
      font-weight:800;
    }

    /* --- Page backgrounds --- */
    .page{ position: relative; }
    .page.hasBg::before{
      content:"";
      position:absolute;
      inset: -14px -14px -14px -14px;
      z-index:-1;
      border-radius: 24px;
      border: 3px solid rgba(255,255,255,.10);
      box-shadow: 0 18px 30px rgba(40,20,80,.08);
      pointer-events:none;
    }

    /* Adventure: pastel sky + map dots */
    #pageAdventure.hasBg::before{
      background:
        radial-gradient(22px 18px at 16% 18%, rgba(255,255,255,.85), transparent 62%),
        radial-gradient(28px 22px at 34% 12%, rgba(255,255,255,.82), transparent 62%),
        radial-gradient(22px 18px at 74% 16%, rgba(255,255,255,.84), transparent 62%),
        radial-gradient(28px 22px at 86% 22%, rgba(255,255,255,.82), transparent 62%),
        radial-gradient(10px 10px at 18% 62%, rgba(255,119,183,.28), transparent 60%),
        radial-gradient(10px 10px at 42% 70%, rgba(53,214,198,.28), transparent 60%),
        radial-gradient(10px 10px at 64% 58%, rgba(255,216,107,.28), transparent 60%),
        radial-gradient(10px 10px at 82% 74%, rgba(143,124,255,.26), transparent 60%),
        linear-gradient(180deg, rgba(205,240,255,.95), rgba(255,242,250,.90));
    }

    /* Pet: cozy room + polka dots */
    #pagePet.hasBg::before{
      background:
        radial-gradient(12px 12px at 16% 24%, rgba(255,255,255,.70), transparent 65%),
        radial-gradient(10px 10px at 34% 14%, rgba(255,255,255,.70), transparent 65%),
        radial-gradient(12px 12px at 66% 18%, rgba(255,255,255,.70), transparent 65%),
        radial-gradient(10px 10px at 86% 28%, rgba(255,255,255,.70), transparent 65%),
        radial-gradient(8px 8px at 18% 62%, rgba(255,119,183,.22), transparent 68%),
        radial-gradient(8px 8px at 32% 78%, rgba(53,214,198,.22), transparent 68%),
        radial-gradient(8px 8px at 58% 64%, rgba(255,216,107,.22), transparent 68%),
        radial-gradient(8px 8px at 78% 80%, rgba(143,124,255,.20), transparent 68%),
        linear-gradient(180deg, rgba(255,240,248,.95), rgba(240,255,252,.90));
    }

    /* Small cute header chip style already in homeMiniRow */

    /* --- Pet visual --- */
    .petHero{
      display:flex;
      justify-content:center;
      align-items:center;
      margin: 8px 0 10px;
    }
    .petHero img{
      width: min(92vw, 520px);
      max-height: 32vh;            /* 1ç”»é¢ã«åã‚ã‚‹ */
      object-fit: contain;
      image-rendering: auto;
      filter: drop-shadow(0 18px 18px rgba(40,20,80,.14));
    }

  
    /* --- LCD frame (Tamagotchi screen) --- */
    .lcd{
      position: relative;
      border-radius: 22px;
      border: 4px solid rgba(0,0,0,.10);
      background: linear-gradient(180deg, rgba(235,255,250,.95), rgba(255,245,252,.92));
      box-shadow:
        inset 0 10px 18px rgba(0,0,0,.08),
        inset 0 -10px 18px rgba(255,255,255,.65),
        0 18px 28px rgba(40,20,80,.10);
      padding: 12px 10px;
      overflow: hidden;
      margin: 8px 0 12px;
    }
    .lcd::before{
      content:"";
      position:absolute; inset:0;
      background:
        repeating-linear-gradient(
          to bottom,
          rgba(0,0,0,.035) 0px,
          rgba(0,0,0,.035) 1px,
          transparent 2px,
          transparent 6px
        );
      mix-blend-mode: multiply;
      opacity: .22;
      pointer-events:none;
    }
    .lcd::after{
      content:"";
      position:absolute; inset:0;
      background: radial-gradient(600px 240px at 20% 0%, rgba(255,255,255,.70), transparent 60%);
      opacity:.55;
      pointer-events:none;
    }

  
    /* --- Adventure story (western sci-fi vibe) --- */
    .storyBlock{
      border: 3px solid var(--line);
      border-radius: 18px;
      padding: 12px 12px;
      background:
        radial-gradient(260px 120px at 18% 0%, rgba(255,255,255,.85), transparent 60%),
        linear-gradient(180deg, rgba(255,255,255,.92), rgba(255,255,255,.76));
      box-shadow:
        inset 0 10px 18px rgba(0,0,0,.06),
        0 16px 22px rgba(40,20,80,.08);
      color: rgba(0,0,0,.70);
      font-weight: 800;
      line-height: 1.75;
      letter-spacing: .2px;
      position: relative;
      overflow: hidden;
      white-space: pre-wrap;
    }
    .storyBlock::before{
      content:"";
      position:absolute; inset:0;
      background:
        repeating-linear-gradient(
          to bottom,
          rgba(0,0,0,.030) 0px,
          rgba(0,0,0,.030) 1px,
          transparent 2px,
          transparent 7px
        );
      opacity:.22;
      pointer-events:none;
      mix-blend-mode:multiply;
    }
    .storyBlock::after{
      content:"";
      position:absolute; inset:-1px;
      border-radius: 18px;
      box-shadow: inset 0 0 0 2px rgba(255,255,255,.55);
      pointer-events:none;
    }

  
    /* --- Sticky HUD (Home top stats) --- */
    .hudBar{
      position: sticky;
      top: calc(env(safe-area-inset-top) + 8px);
      z-index: 50;
      display:grid;
      grid-template-columns: repeat(4,1fr);
      gap:8px;
      padding: 10px 10px;
      border-radius: 18px;
      border: 3px solid var(--line);
      background: rgba(255,255,255,.82);
      backdrop-filter: blur(10px);
      box-shadow: 0 14px 22px rgba(40,20,80,.08);
      margin: 8px 0 10px;
    }
    .hudItem{
      text-align:center;
      font-weight: 900;
      color: rgba(0,0,0,.70);
      padding: 8px 6px;
      border-radius: 14px;
      border: 2px solid rgba(0,0,0,.08);
      background: linear-gradient(180deg, #fff, #fff7fb);
      box-shadow: 0 10px 16px rgba(40,20,80,.06);
      font-size: 12px;
      letter-spacing: .2px;
    }
    .hudItem b{
      display:block;
      font-size: 18px;
      margin-top: 2px;
    }

/* --- Prevent iOS tap zoom on bottom nav --- */
.nav,
.nav button,
.nav .navItem {
  touch-action: manipulation;
  -webkit-tap-highlight-color: transparent;
}

/* æŠ¼ã—ãŸã¨ãã®ã‚ºãƒ¼ãƒ åŸå› ã«ãªã‚‹scaleã‚’ç„¡åŠ¹åŒ– */
.nav button:active,
.nav .navItem:active {
  transform: none !important;
}
/* iPhone Safariã®å…¥åŠ›æ¬„ã‚ºãƒ¼ãƒ é˜²æ­¢ï¼ˆ16pxæœªæº€ã ã¨å‹æ‰‹ã«ã‚ºãƒ¼ãƒ ã™ã‚‹ï¼‰ */
input, select, textarea{
  font-size:16px !important;
}

#pagePet .lcd{
  width:100%;
  max-width:100%;
  box-sizing:border-box;
  margin-left:0 !important;
  margin-right:0 !important;
}


    /* --- FIX: ãƒšãƒƒãƒˆã‚¿ãƒ–ã§ç”»é¢ãŒâ€œã‚ºãƒ¼ãƒ ã£ã½ãâ€ãªã‚‹å•é¡Œï¼ˆPC/ã‚¹ãƒãƒ›å…±é€šï¼‰ --- */
    /* hasBg ã®ç–‘ä¼¼è¦ç´ ãŒãƒã‚¤ãƒŠã‚¹ inset ã ã¨ã€ãƒšãƒ¼ã‚¸ã”ã¨ã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«é ˜åŸŸãŒæºã‚Œã‚‹ã“ã¨ãŒã‚ã‚‹ */
    .page.hasBg::before{
      inset: 0 !important;
    }

    /* ãƒšãƒ¼ã‚¸åˆ‡æ›¿æ™‚ã«é«˜ã•ãŒæºã‚Œãªã„ã‚ˆã†ã«ã€å…¨ãƒšãƒ¼ã‚¸ã§æœ€ä½é«˜ã•ã‚’çµ±ä¸€ */
    .page{
      width: 100%;
      max-width: 100%;
      box-sizing: border-box;
      min-height: calc(100vh - var(--navH) - env(safe-area-inset-bottom)) !important;
    }

    /* ãƒšãƒƒãƒˆã®ãƒ’ãƒ¼ãƒ­ãƒ¼ç”»åƒã¯ vh ä¾å­˜ã‚’ã‚„ã‚ã¦â€œå›ºå®šLCDã‚µã‚¤ã‚ºâ€ã«ã™ã‚‹ï¼ˆãŸã¾ã”ã£ã¡ã£ã½ãï¼‰ */
    .petHero img{
      width: 100% !important;
      max-width: 520px !important;
      height: 240px !important;
      max-height: none !important;
      object-fit: contain !important;
    }

    /* iOS Safari ã®å†æç”»ã‚†ã‚Œå¯¾ç­–ï¼ˆPCã§ã‚‚å®³ãªã—ï¼‰ */
    #pagePet{
      transform: translateZ(0);
    }
/* STARTï¼šRESETã¨åŒç³»è‰²ãƒ»è–„ã‚ */
.start-btn {
  box-shadow:
    0 10px 0 rgba(255, 200, 215, 0.55),   /* æ·¡ã„ãƒ”ãƒ³ã‚¯æ®µå·® */
    0 18px 28px rgba(180, 225, 245, 0.38); /* ã†ã£ã™ã‚‰æ°´è‰²å½± */
}

/* æŠ¼ã—ãŸã¨ã */
.start-btn:active {
  transform: translateY(6px);
  box-shadow:
    0 4px 0 rgba(255, 200, 215, 0.55),
    0 10px 16px rgba(180, 225, 245, 0.38);
}

</style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>

<body>
  <div id="app" class="row">

    <!-- PAGE: HOME -->
    <section id="pageHome" class="page active">
      <h1>ğŸ Home</h1>

      <div class="hudBar" id="hudBar">
        <div class="hudItem">LV <b id="lv">1</b></div>
        <div class="hudItem">XP <b id="xp">0</b></div>
        <div class="hudItem">COIN <b id="coin">0</b></div>
        <div class="hudItem">STREAK <b id="streak">0</b></div>
      </div>


      <div class="homeMiniRow">
        <div class="chip">TODAY <b id="homeTodayMins">â€”</b></div>
        <div class="chip">WEEK <b id="homeWeekMins">â€”</b></div>
        <div class="chip">REMAIN <b id="homeRemainMins">â€”</b></div>
      </div>
      <p class="small" id="homeNeedText" style="margin:0 0 10px;">â€”</p>
<!-- Controls -->
      <div class="card">
        <div class="two">
          <div>
            <label class="muted">ç§‘ç›®</label>
            <select id="subject">
              <option value="è²¡å‹™">è²¡å‹™ä¼šè¨ˆè«–</option>
              <option value="ç®¡ç†">ç®¡ç†ä¼šè¨ˆè«–</option>
              <option value="ç›£æŸ»">ç›£æŸ»è«–</option>
              <option value="ä¼æ¥­">ä¼æ¥­æ³•</option>
              <option value="å¤§å­¦èª²é¡Œ">å¤§å­¦èª²é¡Œ</option>
            </select>
          </div>
          <div>
            <label class="muted">ã‚¿ã‚¹ã‚¯åï¼ˆä»»æ„ï¼‰</label>
            <input id="task" placeholder="ä¾‹ï¼šçŸ­ç­”A 10å• / ä¾‹é¡Œ3é¡Œ ãªã©" />
          </div>
        </div>

        <div class="screen-frame">
          <div id="timer">25:00</div>
        </div>

        <div class="two">
          <button id="start" class="btn primary start-btn">â–¶ START</button>
          <button id="pause" class="secondary">â¸ PAUSE</button>
        </div>
        <div style="height:10px"></div>
        <div class="two">
          <button id="done" class="secondary">âœ… å®Œäº†</button>
          <button id="reset" class="danger">â†º ãƒªã‚»ãƒƒãƒˆ</button>
        </div>
        <div style="height:10px"></div>
        <button id="skipBreak" class="secondary" style="display:none;">â­ ä¼‘æ†©ã‚¹ã‚­ãƒƒãƒ—</button>
        <p class="small">â€»å®Œäº†ãƒœã‚¿ãƒ³ã¯ã‚¿ã‚¤ãƒãƒ¼0ã˜ã‚ƒãªãã¦ã‚‚æŠ¼ã›ã‚‹ã€‚æŠ¼ã—ãŸç¬é–“ã«ã€Œä»Šå›ã®å‹‰å¼·æ™‚é–“ã€ãŒè¨˜éŒ²ã•ã‚Œã‚‹ã€‚</p>
      </div>

      <!-- Countdown -->
      <div class="card">
        <div class="muted" style="margin-bottom:8px;">â³ çŸ­ç­”å¼è©¦é¨“ã¾ã§</div>
        <div class="stats" style="grid-template-columns:repeat(3,1fr);">
          <div class="stat"><span class="muted">DAYS</span><b id="cdDays">â€”</b></div>
          <div class="stat"><span class="muted">HOURS</span><b id="cdHours">â€”</b></div>
          <div class="stat"><span class="muted">MIN</span><b id="cdMins">â€”</b></div>
        </div>
        <p class="small" id="cdText" style="margin:10px 0 0;">â€”</p>
      </div>
<!-- Gacha + Save -->
      <div class="card">
        <div class="two">
          <button id="gacha" class="secondary">ğŸ ã‚¬ãƒãƒ£ï¼ˆ30ã‚³ã‚¤ãƒ³ï¼‰</button>
          <button id="save" class="secondary">ğŸ’¾ æ‰‹å‹•ã‚»ãƒ¼ãƒ–</button>
        </div>
        <div id="rewardBox" class="reward small" style="display:none;"></div>
        <div class="small" style="margin-top:10px;">ãƒ’ãƒ³ãƒˆï¼šã‚¬ãƒãƒ£ã§ã€Œç¾å®Ÿã®ã”è¤’ç¾ã€ã‚’å¼•ãã¨åŠ¹ãã€‚</div>
      </div>

      <!-- Log -->
      <div class="card">
        <div class="muted" style="margin-bottom:8px;">å±¥æ­´ï¼ˆæœ€æ–°ãŒä¸Šï¼‰</div>
        <div class="log" id="log"></div>
      </div>
    </section>

    <!-- PAGE: ADVENTURE -->
    <section id="pageAdventure" class="page hasBg">
      <h1>ğŸ—ºAdventure </h1>
      <!-- Adventure (KEEP) -->
      <div class="card">
        <div class="muted" style="margin-bottom:8px;">ğŸ—º Adventure</div>
        <div class="two">
          <div class="panel area-panel town" id="areaPanel">
            <div class="muted">ç¾åœ¨åœ°</div>
            <div style="font-size:18px; font-weight:900; margin-top:6px;" id="areaName">â€”</div>
            <div class="small" id="areaStep">â€”</div>
            <div class="panel-icon" id="areaIcon" aria-hidden="true">ğŸ˜ï¸</div>
          </div>
          <div class="panel title-panel" id="titlePanel">
            <div class="muted">ç§°å·</div>
            <div style="font-size:18px; font-weight:900; margin-top:6px;" id="titleName">â€”</div>
            <div class="small" id="titleHint">â€”</div>
            <div class="panel-icon" id="titleIcon" aria-hidden="true">ğŸ·ï¸</div>
          </div>
        </div>

        <div style="height:10px"></div>
        <div class="muted" style="margin-bottom:6px;">é€²è¡ŒçŠ¶æ³</div>
        <div style="background:rgba(0,0,0,.05); border-radius:999px; overflow:hidden; height:14px; border:2px solid var(--line);">
          <div id="areaBar" style="height:14px; width:0%; background:linear-gradient(180deg, #d7f4ff, #76d6ff);"></div>
        </div>

        <div style="height:10px"></div>
        <button id="adventureLogBtn" class="secondary">ğŸ“œ å†’é™ºãƒ­ã‚°ã‚’è¡¨ç¤º</button>
        <div id="adventureLog" class="small" style="display:none; margin-top:10px;"></div>
      </div>

      <div class="card">
        <div class="muted" style="margin-bottom:8px;">ğŸ“Ÿ èˆªè¡Œè¨˜éŒ² / NAV LOG</div>

        <div class="storyBlock" id="storyArea">
          â€”
        </div>

        <div style="height:12px"></div>
        <div class="muted" style="margin-bottom:8px;">ğŸ· å‹²ç« å°å¸³ / TITLE REGISTRY</div>

        <div class="storyBlock" id="storyTitle">
          â€”
        </div>
      </div>

    
    </section>

    <!-- PAGE: PET -->
    <section id="pagePet" class="page hasBg">
      <h1>ğŸ£ Pet</h1>
      <div class="lcd">
<div class="petHero">
        <img id="petImg" src="pet_neutral.png" alt="Pet" />
      </div>
</div>
      <!-- Pet -->
      <div class="card">
        <div class="muted" style="margin-bottom:8px;">ğŸ£ Pet</div>

        <div class="two">
          <div>
            <div class="muted">åå‰</div>
            <input id="petName" placeholder="ä¾‹ï¼šã¾ã£ã•" />
          </div>
          <div>
            <div class="muted">çŠ¶æ…‹</div>
            <div style="font-size:18px; font-weight:900; margin-top:6px;" id="petMood">â€”</div>
            <div class="small" id="petTalk">â€”</div>
          </div>
        </div>

        <div style="height:10px"></div>

        <div class="stats">
          <div class="stat"><span class="muted">PET LV</span><b id="petLv">1</b></div>
          <div class="stat"><span class="muted">ãªã¤ã</span><b id="petBond">0</b></div>
          <div class="stat"><span class="muted">ãã’ã‚“</span><b id="petMoodVal">0</b></div>
          <div class="stat"><span class="muted">æº€è…¹</span><b id="petFood">0</b></div>
        </div>

        <div style="height:10px"></div>

        <div class="two">
          <button id="petFeed" class="secondary">ğŸ– ãŠã‚„ã¤ï¼ˆ10ã‚³ã‚¤ãƒ³ï¼‰</button>
          <button id="petPet" class="secondary">ğŸ«³ ãªã§ã‚‹ï¼ˆ1æ—¥3å›ï¼‰</button>
        </div>
        <p class="small">â€»æ”¾ç½®ã™ã‚‹ã¨ç©ºè…¹ï¼†ä¸æ©Ÿå«Œã€‚2æ—¥ç©ºãã¨ç½ªæ‚ªæ„Ÿã‚»ãƒªãƒ•ãŒæ¥ã‚‹ã€‚</p>
      </div>
    </section>

    <!-- PAGE: STUDY -->
    <section id="pageStudy" class="page">
      <h1>ğŸ“ˆ Study log</h1>

      <div class="card">
        <div class="muted" style="margin-bottom:8px;">ğŸ“Š ç›´è¿‘7æ—¥</div>
        <div class="chart-wrap">
          <canvas id="studyChart" height="160"></canvas>
        </div>

        <div style="height:10px"></div>
        <div class="stats" style="grid-template-columns:repeat(3,1fr);">
          <div class="stat"><span class="muted">TODAY</span><b id="todayMins">â€”</b><div class="small"></div></div>
          <div class="stat"><span class="muted">THIS WEEK</span><b id="weekMins">â€”</b><div class="small"></div></div>
          <div class="stat"><span class="muted">WEEK GOAL</span><b id="goalMins">â€”</b><div class="small"></div></div>
        </div>

        <div style="height:10px"></div>
        <div class="stats" style="grid-template-columns:repeat(3,1fr);">
          <div class="stat"><span class="muted">REMAIN</span><b id="remainMins">â€”</b><div class="small"></div></div>
          <div class="stat"><span class="muted">DAYS LEFT</span><b id="daysLeft">â€”</b><div class="small">æ—¥</div></div>
          <div class="stat"><span class="muted">NEED / DAY</span><b id="needPerDay">â€”</b><div class="small"></div></div>
        </div>

        <div style="height:10px"></div>
        <div class="weekbox">
          <div class="kpi">
            <div class="muted">é€±ã®ç›®æ¨™ï¼ˆæ™‚é–“ï¼‰</div>
            <input id="weeklyGoalHours" type="number" min="0" step="0.5" placeholder="ä¾‹ï¼š70" />
            <div class="small" id="goalHint" style="margin-top:6px;">â€”</div>
          </div>
          <div>
            <button id="setWeeklyGoal" class="secondary">ğŸ“Œ æœˆæ›œã«ç›®æ¨™ã‚’è¨­å®š</button>
            <div class="small" id="goalStatus" style="margin-top:8px;">â€”</div>
          </div>
        </div>

        <div style="height:10px"></div>
        <div class="muted" style="margin-bottom:6px;">é€±ã®é€²æ—</div>
        <div style="background:rgba(0,0,0,.05); border-radius:999px; overflow:hidden; height:14px; border:2px solid var(--line);">
          <div id="weekBar" style="height:14px; width:0%; background:linear-gradient(180deg, #d7f4ff, #76d6ff);"></div>
        </div>

        <div style="height:14px"></div>
        <div class="muted" style="margin-bottom:8px;">ğŸ¥§ è¨˜éŒ²åˆ†æ</div>

<div class="two">
  <!-- ç›®æ¨™é”æˆï¼ˆ100%ï¼‰ -->
  <div>
    <div class="small" style="margin:0 0 6px; font-weight:900;">ğŸ¯ é€±ç›®æ¨™ï¼ˆ100%ï¼‰</div>
    <div class="chart-wrap">
      <canvas id="goalPie" height="220"></canvas>
    </div>
    <div class="small" id="goalPieHint" style="margin-top:8px;">â€”</div>
  </div>

  <!-- ç§‘ç›®ãƒãƒ©ãƒ³ã‚¹ -->
  <div>
    <div class="small" style="margin:0 0 6px; font-weight:900;">ğŸ“š ç§‘ç›®ãƒãƒ©ãƒ³ã‚¹</div>
    <div class="chart-wrap">
      <canvas id="subjectPie" height="220"></canvas>
    </div>
    <div class="legend" id="pieLegend"></div>
    <div class="small" id="pieHint" style="margin-top:8px;">â€”</div>
  </div>
</div>

      </div>
    </section>

    <!-- PAGE: ABOUT/SET -->
    <section id="pageInfo" class="page">
      <h1>âš™ï¸ Menu</h1>
      <div class="card">
        <div class="muted" style="margin-bottom:8px;">ä¾¿åˆ©</div>
        <button id="exportJson" class="secondary">ğŸ“¤ ãƒ‡ãƒ¼ã‚¿æ›¸ãå‡ºã—ï¼ˆJSONï¼‰</button>
        <div style="height:10px"></div>
        <button id="wipe" class="danger">ğŸ§¨ å…¨ãƒ‡ãƒ¼ã‚¿åˆæœŸåŒ–</button>
        <p class="small" style="margin-top:10px;">
          â€»åˆæœŸåŒ–ã¯å–ã‚Šæ¶ˆã—ä¸å¯ã€‚æ›¸ãå‡ºã—ã¦ã‹ã‚‰ãŒå®‰å…¨ã€‚
        </p>
        <div id="exportBox" class="reward small" style="display:none; white-space:pre-wrap;"></div>
<div style="height:14px"></div>

<div class="muted" style="margin-bottom:8px;">ğŸ“¥ ãƒ‡ãƒ¼ã‚¿å–ã‚Šè¾¼ã¿ï¼ˆImportï¼‰</div>

<textarea id="importText" placeholder="ã“ã“ã«æ›¸ãå‡ºã—ãŸJSONã‚’è²¼ã‚Šä»˜ã‘ã‚‹ï¼ˆå…¨éƒ¨ï¼‰"
  style="
    width:100%;
    min-height:140px;
    padding:12px 14px;
    border-radius:18px;
    border:2px solid var(--line);
    outline:none;
    background:#fff;
    box-shadow: 0 8px 18px rgba(30,20,70,.06);
    font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', monospace;
    font-size:12px;
    color:var(--text);
  "></textarea>

<div style="height:10px"></div>

<div class="two">
  <button id="importBtn" class="secondary">ğŸ“¥ ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¦ä¸Šæ›¸ã</button>
  <button id="copyExport" class="secondary">ğŸ“‹ æ›¸ãå‡ºã—JSONã‚’ã‚³ãƒ”ãƒ¼</button>
</div>

<p class="small" style="margin-top:10px;">
  â€»ã‚¤ãƒ³ãƒãƒ¼ãƒˆã¯ <b>ã“ã®ç«¯æœ«ã®ãƒ‡ãƒ¼ã‚¿ã‚’ä¸Šæ›¸ã</b> ã™ã‚‹ã€‚å…ˆã«æ›¸ãå‡ºã—ã§ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—æ¨å¥¨ã€‚
</p>
<div style="height:16px"></div>

<div class="muted" style="margin-bottom:8px;">â˜ï¸ è‡ªå‹•åŒæœŸï¼ˆSupabaseï¼‰</div>

<div class="two">
  <div>
    <label class="muted">ãƒ¡ãƒ¼ãƒ«</label>
    <input id="loginEmail" placeholder="you@example.com" autocomplete="email" inputmode="email" />
  </div>
  <div>
    <label class="muted">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼ˆä»»æ„ï¼‰</label>
    <input id="loginPass" type="password" placeholder="ï¼ˆãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰æ–¹å¼ãªã‚‰å…¥åŠ›ï¼‰" autocomplete="current-password" />
  </div>
</div>

<div style="height:10px"></div>

<div class="two">
  <button id="signinPassBtn" class="secondary">ğŸ”“ ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã§ãƒ­ã‚°ã‚¤ãƒ³</button>
  <button id="signupBtn" class="secondary">ğŸ†• æ–°è¦ç™»éŒ²ï¼ˆãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼‰</button>
</div>

<div style="height:10px"></div>

<div class="two">
  <button id="resetPassBtn" class="secondary">ğŸ§· ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å†è¨­å®šãƒ¡ãƒ¼ãƒ«</button>
  <button id="loginBtn" class="secondary">ğŸ”‘ ãƒã‚¸ãƒƒã‚¯ãƒªãƒ³ã‚¯é€ä¿¡</button>
</div>

<div style="height:10px"></div>

<div class="two">
  <div>
    <label class="muted">çŠ¶æ…‹</label>
    <div id="cloudStatus" class="small" style="margin-top:10px;">æœªãƒ­ã‚°ã‚¤ãƒ³</div>
  </div>
  <div>
    <label class="muted">åŒæœŸ</label>
    <div class="small" style="margin-top:10px;">åŒã˜ãƒ–ãƒ©ã‚¦ã‚¶ã§ãƒ­ã‚°ã‚¤ãƒ³ã™ã‚‹ã¨å®‰å®š</div>
  </div>
</div>

<div style="height:10px"></div>

<div class="two">
  <button id="logoutBtn" class="secondary">ğŸšª ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
  <button id="showSyncHelp" class="secondary">ğŸ§© è¨­å®šãƒ¡ãƒ¢</button>
</div>
<div style="height:10px"></div>

<div class="two">
  <button id="cloudPull" class="secondary">â¬‡ï¸ ä»Šã™ãå–ã‚Šè¾¼ã¿</button>
  <button id="cloudPush" class="secondary">â¬†ï¸ ä»Šã™ãé€ä¿¡</button>
</div>

<div style="height:10px"></div>

<div class="two">
  <button id="syncToggle" class="secondary">ğŸ” è‡ªå‹•åŒæœŸï¼šON</button>
  <button class="secondary" disabled style="opacity:.5; cursor:not-allowed;">â€”</button>
</div>

<div id="syncHelpBox" class="reward small" style="display:none; white-space:pre-wrap; margin-top:10px;"></div>

<p class="small" style="margin-top:10px;">
  â€»è‡ªå‹•åŒæœŸã¯ã€ŒSupabase URL / anon keyã€ã‚’ã‚³ãƒ¼ãƒ‰å†…ã«è¨­å®šã™ã‚‹ã¨å‹•ãã€‚<br>
  â€»è¤‡æ•°ç«¯æœ«ã§åŒã˜ãƒ¡ãƒ¼ãƒ«ã§ãƒ­ã‚°ã‚¤ãƒ³ã™ã‚‹ã¨ã€ãƒ‡ãƒ¼ã‚¿ãŒæƒã†ã€‚
</p>
      </div>
    </section>
  </div>

  <!-- Bottom Nav -->
  <div class="nav">
    <div class="nav-inner">
      <button class="navbtn active" id="tabHome" data-page="home" aria-label="ãƒ›ãƒ¼ãƒ " title="ãƒ›ãƒ¼ãƒ ">ğŸ </button>
      <button class="navbtn" id="tabStudy" data-page="study" aria-label="ã‚¹ã‚¿ãƒ‡ã‚£ãƒ­ã‚°" title="ã‚¹ã‚¿ãƒ‡ã‚£ãƒ­ã‚°">ğŸ“ˆ</button>
      <button class="navbtn" id="tabAdventure" data-page="adventure" aria-label="Adventure" title="Adventure">ğŸ—º</button>
      <button class="navbtn" id="tabPet" data-page="pet" aria-label="Pet" title="Pet">ğŸ£</button>
      <button class="navbtn" id="tabInfo" data-page="info" aria-label="ãƒ¡ãƒ‹ãƒ¥ãƒ¼" title="ãƒ¡ãƒ‹ãƒ¥ãƒ¼">âš™ï¸</button>
    </div>
  </div>

<script>
  // ---------- Utils ----------
  const $ = (id) => document.getElementById(id);
  function clamp(n, a, b){ return Math.max(a, Math.min(b, n)); }
  function escapeHtml(str){
    return (str||"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;");
  }

  function fmtHM(mins){
    mins = Math.max(0, Math.round(mins || 0));
    const h = Math.floor(mins / 60);
    const mm = mins % 60;
    if (h > 0 && mm > 0) return `${h}æ™‚é–“${mm}åˆ†`;
    if (h > 0) return `${h}æ™‚é–“`;
    return `${mm}åˆ†`;
  }

  const KEY = "cpaQuest_tabs_v1";
  const todayKey = () => {
  const d = new Date();
  const y = d.getFullYear();
  const m = String(d.getMonth() + 1).padStart(2, "0");
  const day = String(d.getDate()).padStart(2, "0");
  return `${y}-${m}-${day}`;
};

  const pad2 = (n)=>String(n).padStart(2,"0");

  // Week helpers
  function getMonday(d){
    const x = new Date(d);
    const day = (x.getDay() + 6) % 7; // Mon=0 ... Sun=6
    x.setHours(0,0,0,0);
    x.setDate(x.getDate() - day);
    return x;
  }
  function getSunday(d){
    const m = getMonday(d);
    const s = new Date(m);
    s.setDate(s.getDate()+6);
    s.setHours(0,0,0,0);
    return s;
  }
  function weekKeyFromDate(d){
    const date = new Date(d);
    const monday = getMonday(date);
    const jan4 = new Date(monday.getFullYear(),0,4);
    const jan4Mon = getMonday(jan4);
    const diffDays = Math.round((monday - jan4Mon) / (1000*60*60*24));
    const weekNo = 1 + Math.floor(diffDays / 7);
    return `${monday.getFullYear()}-${pad2(weekNo)}`;
  }
  function isMondayLocal(){ return new Date().getDay() === 1; }
  function daysLeftInWeekInclusive(){
    const now = new Date(); now.setHours(0,0,0,0);
    const sunday = getSunday(now);
    const diffDays = Math.round((sunday - now) / (1000*60*60*24));
    return diffDays + 1;
  }

  // ---------- Adventure (Areas / Titles) ----------
  const AREAS = [
    { key:"town",   name:"ã¯ã˜ã¾ã‚Šã®è¡—", steps:10, onEnter: () => ({ coin: 20, msg:"ğŸ  å®¿å±‹ã§ä¼‘ã‚“ã ï¼+20ã‚³ã‚¤ãƒ³" }) },
    { key:"forest", name:"ãã‚‰ã‚ãã®æ£®", steps:20, onEnter: () => ({ coin: 30, msg:"ğŸŒ² å®ç®±ã‚’ç™ºè¦‹ï¼+30ã‚³ã‚¤ãƒ³" }) },
    { key:"cave",   name:"é›†ä¸­ã®æ´çªŸ",   steps:40, onEnter: () => ({ xp:  20, msg:"ğŸ•¯ æ´çªŸã®å¥¥ã§æ‚Ÿã‚Šï¼+20XP" }) },
    { key:"tower",  name:"çŸ­ç­”ã®å¡”",     steps:80, onEnter: () => ({ coin: 40, msg:"ğŸ—¼ å¡”ã®å…¥å£ã«åˆ°é”ï¼+40ã‚³ã‚¤ãƒ³" }) },
    { key:"castle", name:"åˆæ ¼ã®åŸ",     steps:160, onEnter: () => ({ coin: 60, xp: 30, msg:"ğŸ° åŸãŒè¦‹ãˆãŸâ€¦ï¼+60ã‚³ã‚¤ãƒ³ +30XP" }) },
  ];

  const TITLES = [
    { key:"rookie",     name:"è¦‹ç¿’ã„å†’é™ºè€…", hint:"ã¾ãšã¯1å›å®Œäº†", check:(s)=>s.totalCompletions>=1,
      reward:{ coin:10, msg:"ğŸ· ç§°å·GETï¼šè¦‹ç¿’ã„å†’é™ºè€…ï¼ˆ+10ã‚³ã‚¤ãƒ³ï¼‰" } },
    { key:"streak3",    name:"ç¶™ç¶šã®èŠ½", hint:"STREAK 3é”æˆ", check:(s)=>s.streak>=3,
      reward:{ coin:20, msg:"ğŸ· ç§°å·GETï¼šç¶™ç¶šã®èŠ½ï¼ˆ+20ã‚³ã‚¤ãƒ³ï¼‰" } },
    { key:"pomodoro10", name:"ãƒãƒ¢ãƒ‰ãƒ¼ãƒ­æˆ¦å£«", hint:"å®Œäº†å›æ•°10å›", check:(s)=>s.totalCompletions>=10,
      reward:{ coin:40, msg:"ğŸ· ç§°å·GETï¼šãƒãƒ¢ãƒ‰ãƒ¼ãƒ­æˆ¦å£«ï¼ˆ+40ã‚³ã‚¤ãƒ³ï¼‰" } },
    { key:"calc20",     name:"è¨ˆç®—ã®ç‹‚æˆ¦å£«", hint:"è²¡å‹™orç®¡ç† å®Œäº†20å›",
      check:(s)=>((s.bySubject?.è²¡å‹™||0)+(s.bySubject?.ç®¡ç†||0))>=20,
      reward:{ xp:30, msg:"ğŸ· ç§°å·GETï¼šè¨ˆç®—ã®ç‹‚æˆ¦å£«ï¼ˆ+30XPï¼‰" } },
    { key:"law20",      name:"æ¡æ–‡ã‚¹ãƒŠã‚¤ãƒ‘ãƒ¼", hint:"ä¼æ¥­æ³• å®Œäº†20å›", check:(s)=>(s.bySubject?.ä¼æ¥­||0)>=20,
      reward:{ coin:50, msg:"ğŸ· ç§°å·GETï¼šæ¡æ–‡ã‚¹ãƒŠã‚¤ãƒ‘ãƒ¼ï¼ˆ+50ã‚³ã‚¤ãƒ³ï¼‰" } },
    { key:"audit20",    name:"ç›£æŸ»ã®é‘‘", hint:"ç›£æŸ»è«– å®Œäº†20å›", check:(s)=>(s.bySubject?.ç›£æŸ»||0)>=20,
      reward:{ coin:50, msg:"ğŸ· ç§°å·GETï¼šç›£æŸ»ã®é‘‘ï¼ˆ+50ã‚³ã‚¤ãƒ³ï¼‰" } },
    { key:"reachCastle",name:"åˆæ ¼ãŒè¦‹ãˆã‚‹è€…", hint:"åˆæ ¼ã®åŸã«åˆ°é”", check:(s)=>s.areaIndex>=(AREAS.length-1),
      reward:{ coin:100, xp:50, msg:"ğŸ· ç§°å·GETï¼šåˆæ ¼ãŒè¦‹ãˆã‚‹è€…ï¼ˆ+100ã‚³ã‚¤ãƒ³ +50XPï¼‰" } },
  ];

  // ---------- Story texts (western sci-fi flavor) ----------
  const AREA_STORY = {
    town:   "éœ§ã®æ¸¯æ¹¾éƒ½å¸‚ã€Šã‚¢ã‚¹ãƒˆãƒªã‚¢ã€‹ã«æ¥ç¶šã€‚\nç›£æŸ»é™¢ã®å°å°æ›¸åº«ã¸å‘ã‹ã†ãŸã‚ã€ã¾ãšã¯åŸºç¤ãƒ‡ãƒ¼ã‚¿ã‚’å›åã›ã‚ˆã€‚",
    forest: "å…‰è‹”ãŒæºã‚Œã‚‹ã€Šãƒ—ãƒªã‚ºãƒ æ—ã€‹ã€‚\næ¡æ–‡ç‰‡ï¼ˆFragmentsï¼‰ã‚’æ‹¾ã„é›†ã‚ã€èˆªè·¯ã‚’å®‰å®šåŒ–ã•ã›ã‚ã€‚",
    cave:   "æ·±å±¤ã€Šãƒ•ã‚©ãƒ¼ã‚«ã‚¹ãƒ»ã‚±ã‚¤ãƒ–ã€‹ã«çªå…¥ã€‚\né›‘éŸ³ã‚’é®æ–­ã—ã€æ¼”ç®—ç²¾åº¦ã‚’ä¸Šã’ã‚‹ã€‚",
    tower:  "å¡”ã€ŠSHORT-COREã€‹ã®èµ·å‹•ã‚’ç¢ºèªã€‚\nåˆ¶é™æ™‚é–“å†…ã«ã€å•é¡Œç¾¤ã‚’çªç ´ã›ã‚ˆã€‚",
    castle: "è¦å¡ã€ŠPASS FORTRESSã€‹ãŒè¦–ç•Œã«å…¥ã£ãŸã€‚\næœ€çµ‚éµã¯â€œç¶™ç¶šâ€ã€‚æ®‹ã‚Šã¯ã€æ·¡ã€…ã¨ç©ã‚€ã ã‘ã ã€‚"
  };

  const TITLE_STORY = {
    rookie:      "ç™»éŒ²å®Œäº†ã€‚å›ã®IDã¯ã¾ã ç™½ç´™ã ã€‚\nã ãŒç™½ç´™ã¯ã€å¼·ã„ã€‚",
    streak3:     "è¨˜éŒ²ãŒé€£ç¶šã—ãŸã€‚èŠ½ã¯æŠ˜ã‚Œã‚„ã™ã„ã€‚\nã ã‹ã‚‰å®ˆã‚Œã€‚æ¯æ—¥ã€1å›ã§ã„ã„ã€‚",
    pomodoro10:  "â€œ25åˆ†â€ã¯å„€å¼ã ã€‚\næ™‚é–“ã‚’å‘³æ–¹ã«ã—ãŸè€…ã ã‘ãŒã€å¡”ã‚’ç™»ã‚Œã‚‹ã€‚",
    calc20:      "æ•°å€¤ã¯å˜˜ã‚’ã¤ã‹ãªã„ã€‚\nãŸã ã—ã€èª­ã¿æ‰‹ãŒå˜˜ã‚’ã¤ãã€‚",
    law20:       "æ¡æ–‡ã¯åˆƒã ã€‚æŒ¯ã‚Šå›ã™ãªã€‚\nç‹™ã£ã¦æ’ƒã¦ã€‚",
    audit20:     "ç–‘ã†ã®ã¯æ•µæ„ã˜ã‚ƒãªã„ã€‚\nå®ˆã‚‹ãŸã‚ã®ä½œæ³•ã ã€‚",
    reachCastle: "åˆ°é”è€…ã«ã®ã¿è¦‹ãˆã‚‹å…‰ãŒã‚ã‚‹ã€‚\nãŸã ã—æ…¢å¿ƒã¯ã€ãƒ­ã‚°ã‚’æ¶ˆã™ã€‚"
  };

  // ---------- Rewards pool ----------
  const gachaPool = [
  "ğŸ« ãƒãƒ§ã‚³ 1å€‹OK", "ğŸµ ã’ã‚“ã˜ã¶MV 1æ›²OK",
  "ğŸ›Œ 10åˆ†ã‚´ãƒ­ã‚´ãƒ­ OK", "ğŸ“± SNS 5åˆ†OK",
  "âœ¨ ã’ã‚“ã˜ã¶TikTok 5åˆ†OK", "ğŸ’– ã‚¢ã‚¤ã‚«ãƒ„MV 1æ›²OK"
];

  // ---------- State ----------
  const defaultState = () => ({
    uiPage: "home",

    lv: 1, xp: 0, coin: 0,
    streak: 0,
    lastDoneDate: null,

    logs: [],
    totalCompletions: 0,
    bySubject: { è²¡å‹™:0, ç®¡ç†:0, ç›£æŸ»:0, ä¼æ¥­:0, "å¤§å­¦èª²é¡Œ":0 },

    // adventure
    areaIndex: 0,
    areaStep: 0,
    unlockedTitles: [],
    currentTitleKey: "rookie",
    adventureLogs: [],

    // Study log
    studyByDate: {},        // {date: minutes}
    weeklyGoalByWeek: {},   // {weekKey: minutesGoal}

    // pet
    pet: {
      name: "ã¾ã£ã•",
      lv: 1,
      xp: 0,
      bond: 0,
      mood: 60,
      food: 50,
      lastCheckDate: null,
      petsToday: 0
    }
  });

function mergeDefaults(base, def){
  for (const k in def){
    if (base[k] === undefined) base[k] = def[k];
    else if (def[k] && typeof def[k] === "object" && !Array.isArray(def[k]) && typeof base[k] === "object" && base[k] !== null && !Array.isArray(base[k])) {
      mergeDefaults(base[k], def[k]);
    }
  }
  return base;
}

function migrate(s){
  // ã¾ãšæœ€æ–°ã®defaultStateã®å½¢ã«å¯„ã›ã‚‹
  s = mergeDefaults(s, defaultState());

  // bySubject: å¤§å­¦èª²é¡ŒãŒç„¡ã„å¤ã„ãƒ‡ãƒ¼ã‚¿å¯¾ç­–
  if (s.bySubject && s.bySubject["å¤§å­¦èª²é¡Œ"] == null) s.bySubject["å¤§å­¦èª²é¡Œ"] = 0;

  // logs: minsãŒãªã„å¤ã„ãƒ­ã‚°å¯¾ç­–
  if (Array.isArray(s.logs)){
    s.logs = s.logs.map(l => ({
      ...l,
      mins: (typeof l.mins === "number" ? l.mins : 0),
    }));
  } else {
    s.logs = [];
  }

  // studyByDate/weeklyGoalByWeekãŒç„¡ã„å ´åˆ
  if (!s.studyByDate || typeof s.studyByDate !== "object") s.studyByDate = {};
  if (!s.weeklyGoalByWeek || typeof s.weeklyGoalByWeek !== "object") s.weeklyGoalByWeek = {};

  return s;
}

  function load() {
  try {
    const s = JSON.parse(localStorage.getItem(KEY));
    return s ? migrate(s) : defaultState();
  } catch {
    return defaultState();
  }
}
  function persist() { localStorage.setItem(KEY, JSON.stringify(state)); scheduleCloudSave(); }
  let state = load();

  // ===== Cloud Sync (Supabase) =====
  // 1) Supabaseã®Project Settings â†’ API ã‹ã‚‰ URL ã¨ anon key ã‚’è²¼ã‚‹
  // 2) Authentication: Email provider ON
  // 3) Table: profiles_state (user_id uuid PK, state_json text, updated_at timestamptz default now())
  // 4) RLS ON + Policy: auth.uid() = user_id ã®ã¿è¨±å¯ï¼ˆSELECT/INSERT/UPDATEï¼‰
  const SUPABASE_URL = "https://meyxgbbikdjgkypzgrfd.supabase.co";       // <- paste here
  const SUPABASE_ANON_KEY = "sb_publishable_DaZ6V1w02WIhCX5bAPTJOA_FFd0fVtz";  // <- paste here


  const hasSupabaseConfig = () => (SUPABASE_URL && SUPABASE_ANON_KEY);

  const sb = (window.supabase && hasSupabaseConfig())
    ? window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY)
    : null;

  let syncEnabled = true;
  let lastCloudUpdatedAt = null;
  let saveDebounce = null;
  let pullInterval = null;

  const deviceId = localStorage.getItem("cpaQuest_deviceId") || (() => {
    const id = (crypto?.randomUUID ? crypto.randomUUID() : String(Date.now()) + Math.random());
    localStorage.setItem("cpaQuest_deviceId", id);
    return id;
  })();

  function setCloudStatus(text){
    const el = $("cloudStatus");
    if (el) el.textContent = text;
  }

  function showSyncHelp(){
    const box = $("syncHelpBox");
    if (!box) return;
    const open = box.style.display !== "none";
    box.style.display = open ? "none" : "block";
    if (!open){
      box.textContent =
`ã€Supabaseå´ã®æœ€ä½è¨­å®šã€‘
- Authentication â†’ Providers â†’ Email: ON
- Table: profiles_state
  user_id uuid PRIMARY KEY
  state_json text
  updated_at timestamptz default now()
- RLS: ON
- Policyï¼ˆä¾‹ï¼‰:
  SELECT: auth.uid() = user_id
  INSERT: auth.uid() = user_id
  UPDATE: auth.uid() = user_id

ã€ã“ã®HTMLå´ã€‘
- SUPABASE_URL / SUPABASE_ANON_KEY ã‚’è²¼ã‚‹
- åŒã˜ãƒ¡ãƒ¼ãƒ«ã§è¤‡æ•°ç«¯æœ«ãƒ­ã‚°ã‚¤ãƒ³ã™ã‚‹ã¨åŒæœŸã§ãã‚‹`;
    }
  }

  async function getUser(){
    if (!sb) return null;
    const { data } = await sb.auth.getUser();
    return data?.user || null;
  }

  async function signInWithEmail(email){
    if (!sb) { showReward("â˜ï¸ Supabaseæœªè¨­å®šã€‚URL/KEYã‚’è²¼ã£ã¦"); return; }
    email = (email || "").trim();
    if (!email) { showReward("ãƒ¡ãƒ¼ãƒ«å…¥ã‚Œã¦"); return; }
    const redirectTo = window.location.origin + window.location.pathname;
    const { error } = await sb.auth.signInWithOtp({
      email,
      options: { emailRedirectTo: redirectTo }
    });
    if (error) {
      console.error(error);
      showReward("âŒ é€ä¿¡å¤±æ•—ï¼ˆåˆ¶é™/URLè¨­å®šã‹ã‚‚ï¼‰");
      setCloudStatus("é€ä¿¡å¤±æ•—");
    } else {
      showReward("ğŸ“© ãƒ¡ãƒ¼ãƒ«ã«ãƒ­ã‚°ã‚¤ãƒ³ãƒªãƒ³ã‚¯é€ã£ãŸ");
      setCloudStatus("ãƒªãƒ³ã‚¯å¾…ã¡â€¦ï¼ˆãƒ¡ãƒ¼ãƒ«ã‚’é–‹ã„ã¦ã‚¯ãƒªãƒƒã‚¯ï¼‰");
    }
  }

  async function signUpWithPassword(email, password){
    if (!sb) { showReward("â˜ï¸ Supabaseæœªè¨­å®šã€‚URL/KEYã‚’è²¼ã£ã¦"); return; }
    email = (email || "").trim();
    password = (password || "");
    if (!email) { showReward("ãƒ¡ãƒ¼ãƒ«å…¥ã‚Œã¦"); return; }
    if (!password || password.length < 8) { showReward("ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯8æ–‡å­—ä»¥ä¸Š"); return; }
    const redirectTo = window.location.origin + window.location.pathname;
    const { error } = await sb.auth.signUp({
      email,
      password,
      options: { emailRedirectTo: redirectTo }
    });
    if (error) {
      console.error(error);
      showReward("âŒ æ–°è¦ç™»éŒ²å¤±æ•—");
      setCloudStatus("ç™»éŒ²å¤±æ•—");
    } else {
      showReward("ğŸ†• ç™»éŒ²OKï¼ˆç¢ºèªãƒ¡ãƒ¼ãƒ«ãŒæ¥ã‚‹å ´åˆã‚ã‚Šï¼‰");
      setCloudStatus("ç™»éŒ²OK");
    }
  }

  async function signInWithPassword(email, password){
    if (!sb) { showReward("â˜ï¸ Supabaseæœªè¨­å®šã€‚URL/KEYã‚’è²¼ã£ã¦"); return; }
    email = (email || "").trim();
    password = (password || "");
    if (!email) { showReward("ãƒ¡ãƒ¼ãƒ«å…¥ã‚Œã¦"); return; }
    if (!password) { showReward("ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å…¥ã‚Œã¦"); return; }
    const { error } = await sb.auth.signInWithPassword({ email, password });
    if (error) {
      console.error(error);
      showReward("âŒ ãƒ­ã‚°ã‚¤ãƒ³å¤±æ•—ï¼ˆãƒ¡ãƒ¼ãƒ«/ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼‰");
      setCloudStatus("æœªãƒ­ã‚°ã‚¤ãƒ³");
    } else {
      showReward("âœ… ãƒ­ã‚°ã‚¤ãƒ³ã—ãŸ");
      await cloudPull({ silent:false, force:true });
    }
  }

  async function sendPasswordReset(email){
    if (!sb) { showReward("â˜ï¸ Supabaseæœªè¨­å®šã€‚URL/KEYã‚’è²¼ã£ã¦"); return; }
    email = (email || "").trim();
    if (!email) { showReward("ãƒ¡ãƒ¼ãƒ«å…¥ã‚Œã¦"); return; }
    const redirectTo = window.location.origin + window.location.pathname;
    const { error } = await sb.auth.resetPasswordForEmail(email, { redirectTo });
    if (error) {
      console.error(error);
      showReward("âŒ å†è¨­å®šãƒ¡ãƒ¼ãƒ«é€ä¿¡å¤±æ•—");
    } else {
      showReward("ğŸ“© å†è¨­å®šãƒ¡ãƒ¼ãƒ«ã‚’é€ã£ãŸ");
      setCloudStatus("å†è¨­å®šãƒ¡ãƒ¼ãƒ«é€ä¿¡");
    }
  }

  async function signOutCloud(){
    if (!sb) return;
    await sb.auth.signOut();
    setCloudStatus("æœªãƒ­ã‚°ã‚¤ãƒ³");
    showReward("ğŸšª ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ãŸ");
  }

  function scheduleCloudSave(){
    if (!sb || !syncEnabled) return;
    clearTimeout(saveDebounce);
    saveDebounce = setTimeout(() => cloudPush(), 1200);
  }

  async function cloudPush(){
    if (!sb) { showReward("â˜ï¸ Supabaseæœªè¨­å®š"); return; }
    const user = await getUser();
    if (!user) { showReward("ğŸ”‘ å…ˆã«ãƒ­ã‚°ã‚¤ãƒ³"); return; }

    state._meta = state._meta || {};
    state._meta.lastDevice = deviceId;
    state._meta.lastSavedAt = new Date().toISOString();

    const payload = JSON.stringify(state);

    const { data, error } = await sb
      .from("profiles_state")
      .upsert({
        user_id: user.id,
        state_json: payload,
        updated_at: new Date().toISOString(),
      }, { onConflict: "user_id" })
      .select("updated_at")
      .single();

    if (error){
      console.error(error);
      showReward("âŒ é€ä¿¡å¤±æ•—ï¼ˆRLS/Policy/ãƒ†ãƒ¼ãƒ–ãƒ«åã‚’ç¢ºèªï¼‰");
      return;
    }

    lastCloudUpdatedAt = data?.updated_at || lastCloudUpdatedAt;
    setCloudStatus(`åŒæœŸOKï¼ˆé€ä¿¡ï¼‰`);
  }

  async function cloudPull(opts = { silent:false, force:false }){
    if (!sb) { if(!opts.silent) showReward("â˜ï¸ Supabaseæœªè¨­å®š"); return; }
    const user = await getUser();
    if (!user) { if(!opts.silent) showReward("ğŸ”‘ å…ˆã«ãƒ­ã‚°ã‚¤ãƒ³"); return; }

    const { data, error } = await sb
      .from("profiles_state")
      .select("state_json, updated_at")
      .eq("user_id", user.id)
      .single();

    if (error){
      console.error(error);
      if(!opts.silent) showReward("âŒ å–ã‚Šè¾¼ã¿å¤±æ•—ï¼ˆãƒ†ãƒ¼ãƒ–ãƒ«/RLSç¢ºèªï¼‰");
      return;
    }
    if (!data?.state_json) {
      if(!opts.silent) showReward("â˜ï¸ ã¾ã ã‚¯ãƒ©ã‚¦ãƒ‰ã«ä¿å­˜ãŒãªã„ï¼ˆã¾ãšé€ä¿¡ï¼‰");
      return;
    }

    // ç«¶åˆï¼šã‚¯ãƒ©ã‚¦ãƒ‰ãŒæ–°ã—ã‘ã‚Œã°å–ã‚Šè¾¼ã‚€ï¼ˆã¾ãŸã¯ç¢ºèªï¼‰
    if (!opts.force && lastCloudUpdatedAt && data.updated_at && data.updated_at <= lastCloudUpdatedAt){
      if(!opts.silent) showReward("â˜ï¸ ã™ã§ã«æœ€æ–°");
      return;
    }

    let next;
    try { next = JSON.parse(data.state_json); }
    catch { if(!opts.silent) showReward("âŒ ã‚¯ãƒ©ã‚¦ãƒ‰ãƒ‡ãƒ¼ã‚¿ãŒå£Šã‚Œã¦ã‚‹"); return; }

    // ãƒ­ãƒ¼ã‚«ãƒ«ã«ä½œæ¥­ãŒã‚ã‚‹æ™‚ã®äº‹æ•…é˜²æ­¢ï¼šç¢ºèª
    if (!opts.force && state?.logs?.length && lastCloudUpdatedAt && data.updated_at && data.updated_at > lastCloudUpdatedAt){
      const ok = confirm("ã‚¯ãƒ©ã‚¦ãƒ‰ã®æ–¹ãŒæ–°ã—ã„ã€‚ãƒ­ãƒ¼ã‚«ãƒ«ã‚’ä¸Šæ›¸ãã—ã¦å–ã‚Šè¾¼ã‚€ï¼Ÿ");
      if (!ok) return;
    }

    state = migrate(next);
    localStorage.setItem(KEY, JSON.stringify(state));
    lastCloudUpdatedAt = data.updated_at || lastCloudUpdatedAt;

    render();
    if(!opts.silent) showReward("â¬‡ï¸ å–ã‚Šè¾¼ã¿å®Œäº†");
    setCloudStatus("åŒæœŸOKï¼ˆå–ã‚Šè¾¼ã¿ï¼‰");
  }

  function startAutoPull(){
    if (!sb) return;
    if (pullInterval) clearInterval(pullInterval);
    pullInterval = setInterval(() => {
      if (!syncEnabled) return;
      cloudPull({ silent:true, force:false });
    }, 20000);
  }

  function stopAutoPull(){
    if (pullInterval) clearInterval(pullInterval);
    pullInterval = null;
  }

  // ---------- UI feedback ----------
  function showReward(text) {
    const box = $("rewardBox");
    box.style.display = "block";
    box.textContent = text;
    setTimeout(() => { box.style.display = "none"; }, 7000);
  }

  // ---------- Leveling ----------
  function xpToNext(lv) { return 100 + (lv-1)*40; }
  function gain(xp, coin) {
    state.xp += xp;
    state.coin += coin;
    while (state.xp >= xpToNext(state.lv)) {
      state.xp -= xpToNext(state.lv);
      state.lv += 1;
      state.coin += 20;
      showReward(`ğŸ‰ LEVEL UP! â†’ Lv.${state.lv}ï¼ˆ+20ã‚³ã‚¤ãƒ³ï¼‰`);
      pushAdventureLog(`ğŸ‰ Lv.${state.lv}ã«ãªã£ãŸ`);
    }
  }

  // ---------- Countdown ----------
  const EXAM_DATE = new Date(2026, 4, 24, 9, 0, 0); // 2026-05-24 09:00 local
  function updateCountdown(){
    const now = new Date();
    let diff = EXAM_DATE - now;
    if (diff < 0) diff = 0;

    const totalMin = Math.floor(diff / (1000*60));
    const days = Math.floor(totalMin / (60*24));
    const hours = Math.floor((totalMin - days*60*24) / 60);
    const mins = totalMin - days*60*24 - hours*60;

    $("cdDays").textContent = days;
    $("cdHours").textContent = hours;
    $("cdMins").textContent = mins;
    $("cdText").textContent = diff===0 ? "æœ¬æ—¥ãŒçŸ­ç­”ã€‚ç‚¹ã«ãªã‚‹è¡Œå‹•ã ã‘ã€‚" : `çŸ­ç­”ï¼ˆ2026/5/24ï¼‰ã¾ã§æ®‹ã‚Šï¼š${days}æ—¥ ${hours}æ™‚é–“ ${mins}åˆ†`;
  }

  // ---------- Streak ----------
  function updateStreakOnDone() {
    const t = todayKey();
    if (!state.lastDoneDate) { state.streak = 1; state.lastDoneDate = t; return; }
    if (state.lastDoneDate === t) return;

    const last = new Date(state.lastDoneDate);
    const now = new Date(t);
    const diffDays = Math.round((now - last) / (1000*60*60*24));

    state.streak = (diffDays === 1) ? (state.streak + 1) : 1;
    state.lastDoneDate = t;
  }

  // ---------- Adventure helpers ----------
  function currentArea() { return AREAS[Math.min(state.areaIndex, AREAS.length-1)]; }
  function pushAdventureLog(line) {
    state.adventureLogs.unshift(`${todayKey()} ${line}`);
    state.adventureLogs = state.adventureLogs.slice(0, 30);
  }

  // ---------- Study log ----------
  function addStudyMinutes(dateKey, mins){
    const cur = state.studyByDate[dateKey] || 0;
    state.studyByDate[dateKey] = cur + mins;
  }
  function getWeekMinutes(mondayDate){
    let sum = 0;
    for (let i=0;i<7;i++){
      const d = new Date(mondayDate);
      d.setDate(d.getDate() + i);
      const k = d.toISOString().slice(0,10);
      sum += (state.studyByDate[k] || 0);
    }
    return sum;
  }
  function getWeeklyGoalMinutesForThisWeek(){
    const wk = weekKeyFromDate(new Date());
    return state.weeklyGoalByWeek[wk] || 0;
  }

  // subject minutes in this week from logs
  function getSubjectMinutesThisWeek(){
    const mon = getMonday(new Date());
    const sun = getSunday(new Date());
    const monKey = mon.toISOString().slice(0,10);
    const sunKey = sun.toISOString().slice(0,10);

    const sums = { è²¡å‹™:0, ç®¡ç†:0, ç›£æŸ»:0, ä¼æ¥­:0, "å¤§å­¦èª²é¡Œ":0 };
    for (const l of (state.logs || [])){
      if (!l.date) continue;
      if (l.date < monKey || l.date > sunKey) continue;
      if (typeof l.mins !== "number") continue;
      if (sums[l.subject] === undefined) continue;
      sums[l.subject] += l.mins;
    }
    return sums;
  }

  function isMondayLocal(){ return new Date().getDay() === 1; }
  function daysLeftInWeekInclusive(){
    const now = new Date(); now.setHours(0,0,0,0);
    const sunday = getSunday(now);
    const diffDays = Math.round((sunday - now) / (1000*60*60*24));
    return diffDays + 1;
  }

  // ---------- Charts ----------
  function setupCanvasDPR(canvas){
    const ctx = canvas.getContext("2d");
    const cssW = canvas.clientWidth;
    const cssH = canvas.clientHeight;
    const dpr = window.devicePixelRatio || 1;
    canvas.width = Math.floor(cssW * dpr);
    canvas.height = Math.floor(cssH * dpr);
    ctx.setTransform(dpr,0,0,dpr,0,0);
    return { ctx, W: cssW, H: cssH };
  }

function localDateKey(date){
  const y = date.getFullYear();
  const m = String(date.getMonth()+1).padStart(2,"0");
  const d = String(date.getDate()).padStart(2,"0");
  return `${y}-${m}-${d}`;
}

  function drawStudyChart(){
    const canvas = $("studyChart");
    if (!canvas) return;
    const { ctx, W, H } = setupCanvasDPR(canvas);

    ctx.clearRect(0,0,W,H);
    ctx.fillStyle = "rgba(255,255,255,0.9)";
    ctx.fillRect(0,0,W,H);

    const days = 7;
    const now = new Date();
    now.setHours(0,0,0,0);

    const data = [];
    let maxM = 60;
    for (let i=days-1;i>=0;i--){
      const d = new Date(now);
      d.setDate(d.getDate() - i);
      const k = localDateKey(d);
      const m = state.studyByDate[k] || 0;
      data.push({ date: d, mins:m });
      if (m > maxM) maxM = m;
    }
    maxM = Math.ceil(maxM / 60) * 60;

    const padL = 28, padR = 10, padT = 10, padB = 24;
    const innerW = W - padL - padR;
    const innerH = H - padT - padB;

    ctx.strokeStyle = "rgba(0,0,0,0.08)";
    ctx.lineWidth = 1;
    for (let t=0;t<=2;t++){
      const y = padT + innerH * (t/2);
      ctx.beginPath(); ctx.moveTo(padL,y); ctx.lineTo(W-padR,y); ctx.stroke();
    }

    
function minsToHM(mins){
  const h = Math.floor(mins/60);
  const m = mins % 60;
  if (h<=0) return `${m}m`;
  if (m===0) return `${h}h`;
  return `${h}h${m}m`;
}

    ctx.fillStyle = "rgba(0,0,0,0.45)";
    ctx.font = "12px system-ui, -apple-system";
    ctx.fillText(minsToHM(maxM), 2, padT+10);
    ctx.fillText(minsToHM(Math.floor(maxM/2)), 2, padT + innerH/2 + 4);

    const barGap = 6;
    const barW = (innerW - barGap*(days-1)) / days;

    for (let i=0;i<days;i++){
      const x = padL + i*(barW+barGap);
      const ratio = data[i].mins / maxM;
      const h = Math.max(0, Math.round(innerH * ratio));
      const y = padT + innerH - h;

      const grad = ctx.createLinearGradient(0,y,0,y+h);
      grad.addColorStop(0, "rgba(118,214,255,0.95)");
      grad.addColorStop(1, "rgba(255,119,183,0.85)");
      ctx.fillStyle = grad;

      const r = 8;
      const bw = barW, bh = h;
      const x0=x, y0=y, x1=x+bw, y1=y+bh;
      const rr = Math.min(r, bw/2, bh/2);

      ctx.beginPath();
      ctx.moveTo(x0+rr,y0);
      ctx.arcTo(x1,y0,x1,y0+rr,rr);
      ctx.arcTo(x1,y1,x1-rr,y1,rr);
      ctx.arcTo(x0,y1,x0,y1-rr,rr);
      ctx.arcTo(x0,y0,x0+rr,y0,rr);
      ctx.closePath();
      ctx.fill();

      if (i % 2 === 0){
        const dd = data[i].date;
        const label = `${dd.getMonth()+1}/${dd.getDate()}`;
        ctx.fillStyle = "rgba(0,0,0,0.55)";
        ctx.font = "12px system-ui, -apple-system";
        ctx.fillText(label, x-2, H-6);
      }
    }
  }

  function drawSubjectPie(){
    const canvas = $("subjectPie");
    if (!canvas) return;

    const { ctx, W, H } = setupCanvasDPR(canvas);
    ctx.clearRect(0,0,W,H);

    const sums = getSubjectMinutesThisWeek();
    const items = [
      { k:"è²¡å‹™", v:sums.è²¡å‹™, c:"#ff77b7" },
      { k:"ç®¡ç†", v:sums.ç®¡ç†, c:"#76d6ff" },
      { k:"ç›£æŸ»", v:sums.ç›£æŸ», c:"#a6ffb8" },
      { k:"ä¼æ¥­", v:sums.ä¼æ¥­, c:"#ffd56a" },
      { k:"å¤§å­¦èª²é¡Œ", v:sums["å¤§å­¦èª²é¡Œ"], c:"#b9a6ff" },
    ];
    const total = items.reduce((a,b)=>a+b.v,0);

    const leg = $("pieLegend");
    if (leg){
      leg.innerHTML = items.map(it => {
        return `<div class="leg">
          <span class="dot" style="background:${it.c}"></span>
          <span>${it.k}</span>
          <span style="margin-left:auto; color:#2a2a36; font-weight:900;">${it.v}m</span>
        </div>`;
      }).join("");
    }

    if (total <= 0){
      $("pieHint").textContent = "ä»Šé€±ã®è¨˜éŒ²ãŒã¾ã ãªã„ã€‚å®Œäº†ã‚’æŠ¼ã™ã¨å††ã‚°ãƒ©ãƒ•ãŒè‚²ã¤ã€‚";
      ctx.fillStyle = "rgba(0,0,0,0.10)";
      ctx.beginPath();
      ctx.arc(W/2, H/2, Math.min(W,H)*0.30, 0, Math.PI*2);
      ctx.fill();
      ctx.fillStyle = "rgba(0,0,0,0.45)";
      ctx.font = "14px system-ui, -apple-system";
      ctx.textAlign = "center";
      ctx.fillText("NO DATA", W/2, H/2+5);
      ctx.textAlign = "left";
      return;
    }

    $("pieHint").textContent = `ä»Šé€±åˆè¨ˆï¼š${fmtHM(total)}ï¼ˆåã‚Šãƒã‚§ãƒƒã‚¯ç”¨ï¼‰`;

    const cx = W/2, cy = H/2;
    const rOuter = Math.min(W,H)*0.34;
    const rInner = rOuter*0.55;

    let start = -Math.PI/2;
    for (const it of items){
      if (it.v <= 0) continue;
      const ang = (it.v / total) * Math.PI*2;
      const end = start + ang;

      ctx.fillStyle = it.c;
      ctx.beginPath();
      ctx.moveTo(cx, cy);
      ctx.arc(cx, cy, rOuter, start, end);
      ctx.closePath();
      ctx.fill();

      start = end;
    }

    ctx.fillStyle = "rgba(255,255,255,0.95)";
    ctx.beginPath();
    ctx.arc(cx, cy, rInner, 0, Math.PI*2);
    ctx.fill();

    ctx.fillStyle = "rgba(0,0,0,0.75)";
    ctx.font = "16px system-ui, -apple-system";
    ctx.textAlign = "center";
    ctx.fillText(`${Math.round(total/60)}h ${total%60}m`, cx, cy+6);
    ctx.textAlign = "left";
  }

function setupCanvasDPR(canvas){
  const ctx = canvas.getContext("2d");
  const cssW = canvas.clientWidth;
  const cssH = canvas.clientHeight;
  const dpr = window.devicePixelRatio || 1;

  canvas.width = Math.floor(cssW * dpr);
  canvas.height = Math.floor(cssH * dpr);

  // ä»¥å¾Œã¯CSSã‚µã‚¤ã‚ºåŸºæº–ã§æã‘ã‚‹
  ctx.setTransform(dpr, 0, 0, dpr, 0, 0);

  return { ctx, W: cssW, H: cssH };
}

function getWeekMinutes(mondayDate){
  let sum = 0;
  for (let i = 0; i < 7; i++){
    const d = new Date(mondayDate);
    d.setDate(d.getDate() + i);
    const k = d.toISOString().slice(0,10);
    sum += (state.studyByDate?.[k] || 0);
  }
  return sum;
}

function drawGoalPie(){
  const canvas = $("goalPie");
  if (!canvas) return;

  const { ctx, W, H } = setupCanvasDPR(canvas);
  ctx.clearRect(0,0,W,H);

  const monday = getMonday(new Date());
  const weekM = getWeekMinutes(monday);
  const goal = getWeeklyGoalMinutesForThisWeek();

  const cx = W/2, cy = H/2;
  const rOuter = Math.min(W,H)*0.36;
  const rInner = rOuter*0.66;

  // èƒŒæ™¯ãƒªãƒ³ã‚°
  ctx.fillStyle = "rgba(0,0,0,0.08)";
  ctx.beginPath();
  ctx.arc(cx, cy, rOuter, 0, Math.PI*2);
  ctx.arc(cx, cy, rInner, 0, Math.PI*2, true);
  ctx.closePath();
  ctx.fill();

  if (!goal || goal <= 0){
    $("goalPieHint").textContent = "é€±ç›®æ¨™ãŒæœªè¨­å®šã€‚æœˆæ›œã«ç›®æ¨™ã‚’å…¥ã‚Œã‚‹ã¨100%ãƒªãƒ³ã‚°ãŒè‚²ã¤ã€‚";
    ctx.fillStyle = "rgba(0,0,0,0.55)";
    ctx.font = "14px system-ui, -apple-system";
    ctx.textAlign = "center";
    ctx.fillText("SET GOAL", cx, cy+5);
    ctx.textAlign = "left";
    return;
  }

  const ratio = clamp(weekM / goal, 0, 1);
  const remain = Math.max(0, goal - weekM);
  const pct = Math.floor(ratio * 100);

  // é€²æ—ãƒªãƒ³ã‚°ï¼ˆã‚°ãƒ©ãƒ‡ï¼‰
  const start = -Math.PI/2;
  const end = start + (Math.PI*2 * ratio);

  const grad = ctx.createLinearGradient(cx-rOuter, cy-rOuter, cx+rOuter, cy+rOuter);
  grad.addColorStop(0, "rgba(118,214,255,0.95)");
  grad.addColorStop(1, "rgba(255,119,183,0.90)");
  ctx.fillStyle = grad;

  ctx.beginPath();
  ctx.moveTo(cx, cy);
  ctx.arc(cx, cy, rOuter, start, end);
  ctx.closePath();
  ctx.fill();

  // ãã‚ŠæŠœã
  ctx.fillStyle = "rgba(255,255,255,0.95)";
  ctx.beginPath();
  ctx.arc(cx, cy, rInner, 0, Math.PI*2);
  ctx.fill();

  // ä¸­å¤®ãƒ†ã‚­ã‚¹ãƒˆ
  ctx.fillStyle = "rgba(0,0,0,0.78)";
  ctx.font = "900 18px system-ui, -apple-system";
  ctx.textAlign = "center";
  ctx.fillText(`${pct}%`, cx, cy-2);

  ctx.fillStyle = "rgba(0,0,0,0.55)";
  ctx.font = "12px system-ui, -apple-system";
  ctx.fillText(`${fmtHM(weekM)} / ${fmtHM(goal)}`, cx, cy+18);
  ctx.textAlign = "left";

  $("goalPieHint").textContent =
    (pct >= 100)
      ? "é”æˆï¼100%è¶…ãˆã€‚ä¸ŠæŒ¯ã‚Œã§å®‰å¿ƒã€‚"
      : `æ®‹ã‚Š ${fmtHM(remain)}ã€‚100%ã‚’ç›®æŒ‡ãã†ã€‚`;
}

  // ---------- Pet ----------
  function petXpToNext(lv) { return 60 + (lv-1)*35; }
  function petSpeak(kind){
    const name = state.pet.name || "Pet";
    const lines = {
      happy: [`${name}ã€Œã‚ˆã—ã€‚ä»Šæ—¥ã‚‚ã‚„ã‚‹ã­ã€‚ã€`,`${name}ã€Œä»Šã®å›è»¢ã€æ°—æŒã¡ã‚ˆã‹ã£ãŸã€‚ã€`,`${name}ã€Œãã®èª¿å­ã€‚ã€`],
      neutral:[`${name}ã€Œâ€¦â€¦ã¾ã ï¼Ÿã€`,`${name}ã€ŒçŸ­ç­”ã€1ã‚»ãƒƒãƒˆã ã‘ã§ã‚‚ã€‚ã€`,`${name}ã€Œè§¦ã£ã¦ã‹ã‚‰è¡Œã£ã¦ã€‚ã€`],
      angry:[`${name}ã€Œã¯ï¼Ÿ é€£ç¶šåˆ‡ã£ãŸï¼Ÿã€`,`${name}ã€Œè¨€ã„è¨³ã¯ã„ã„ã€‚å®Œäº†æŠ¼ã›ã€‚ã€`,`${name}ã€Œè¦‹ã¦ã‚‹ã€‚ã€`],
      starving:[`${name}ã€ŒãŠè…¹ã™ã„ãŸã€‚ã‚³ã‚¤ãƒ³å‡ºã—ã¦ã€‚ã€`,`${name}ã€Œç©ºè…¹ï¼é›†ä¸­0ã€`,`${name}ã€Œé£Ÿã¹ç‰©ï¼è¨€ã„è¨³ã€`],
      guilt:[`${name}ã€Œæ˜¨æ—¥â€¦ã„ãªããªã£ãŸã¨æ€ã£ãŸã€‚ã€`,`${name}ã€Œã§ã‚‚ä»Šæ—¥ã‚„ã‚‹ãªã‚‰è¨±ã™ã€‚ã€`,`${name}ã€Œæˆ»ã£ã¦ããŸï¼Ÿã€`]
    };
    const pool = lines[kind] || lines.neutral;
    return pool[Math.floor(Math.random()*pool.length)];
  }
  function petStatusText(){
    const p = state.pet;
    if (p.food <= 15) return { mood:"ç©ºè…¹", talk: petSpeak("starving") };
    if (p.mood >= 75) return { mood:"ã”ãã’ã‚“", talk: petSpeak("happy") };
    if (p.mood >= 45) return { mood:"ãµã¤ã†", talk: petSpeak("neutral") };
    return { mood:"ãƒ–ãƒã‚®ãƒ¬", talk: petSpeak("angry") };
  }

  function updatePetImage(){
  const el = $("petImg");
  if (!el) return;

  // è¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹çŠ¶æ…‹ã‚’ãã®ã¾ã¾ä½¿ã†
  const moodText = $("petMood")?.textContent;

  let src = "pet_neutral.png";

  if (moodText === "ã”ãã’ã‚“") {
    src = "pet_happy.png";
  } else if (moodText === "ãƒ–ãƒã‚®ãƒ¬" || moodText === "ç©ºè…¹") {
    src = "pet_angry.png";
  }

  if (el.getAttribute("src") !== src) {
    el.setAttribute("src", src);
  }
}

  function petGain(xp, bond, mood, food){
    const p = state.pet;
    p.xp += xp;
    p.bond = clamp(p.bond + bond, 0, 999);
    p.mood = clamp(p.mood + mood, 0, 100);
    p.food = clamp(p.food + food, 0, 100);

    while (p.xp >= petXpToNext(p.lv)) {
      p.xp -= petXpToNext(p.lv);
      p.lv += 1;
      p.bond = clamp(p.bond + 5, 0, 999);
      showReward(`ğŸ‰ ãƒšãƒƒãƒˆãŒæˆé•·ï¼ Lv.${p.lv}ï¼ˆãªã¤ã+5ï¼‰`);
      pushAdventureLog(`ğŸ‰ ãƒšãƒƒãƒˆLv.${p.lv}ã«ãªã£ãŸ`);
    }
  }
  function petDailyTick(){
    const p = state.pet;
    const t = todayKey();
    if (p.lastCheckDate === t) return;

    p.petsToday = 0;

    // daily decay
    p.food = clamp(p.food - 12, 0, 100);

    // neglect = 2+ days no done
    let neglected = false;
    if (!state.lastDoneDate) neglected = true;
    else {
      const last = new Date(state.lastDoneDate);
      const now = new Date(t);
      const diffDays = Math.round((now - last) / (1000*60*60*24));
      neglected = diffDays >= 2;
    }

    if (neglected) {
      p.mood = clamp(p.mood - 25, 0, 100);
      showReward("ğŸ˜¾ ãƒšãƒƒãƒˆãŒæ‹—ã­ã¦ã‚‹ã€‚ä»Šæ—¥1å›ã§ã‚‚å®Œäº†ã—ã¦æ©Ÿå«Œã‚’ç›´ã—ã¦ã€‚");
      pushAdventureLog(petSpeak("guilt"));
    } else {
      p.mood = clamp(p.mood - 8, 0, 100);
    }

    p.lastCheckDate = t;
  }

  // ---------- Pages / Tabs ----------
  function setPage(page){
    document.activeElement?.blur?.();
    requestAnimationFrame(() => window.scrollTo(0, 0));
    state.uiPage = page;
    persist();

    $("pageHome").classList.toggle("active", page==="home");
    $("pageStudy").classList.toggle("active", page==="study");
    $("pageAdventure").classList.toggle("active", page==="adventure");
    $("pagePet").classList.toggle("active", page==="pet");
    $("pageInfo").classList.toggle("active", page==="info");

    $("tabHome").classList.toggle("active", page==="home");
    $("tabStudy").classList.toggle("active", page==="study");
    $("tabAdventure").classList.toggle("active", page==="adventure");
    $("tabPet").classList.toggle("active", page==="pet");
    $("tabInfo").classList.toggle("active", page==="info");

    if (page === "study") {
      setTimeout(() => { drawStudyChart(); drawGoalPie(); drawSubjectPie(); }, 0);
    }
      // keep UI in sync when switching tabs
    render();
  }

  // ---------- Render ----------
  function render() {
    // stats
    $("lv").textContent = state.lv;
    $("xp").textContent = state.xp;
    $("coin").textContent = state.coin;
    $("streak").textContent = state.streak;

    // log
    $("log").innerHTML = (state.logs||[]).slice(0,50).map(l => {
      const mins = (typeof l.mins === "number") ? ` / ${l.mins}åˆ†` : "";
      return `<div style="margin:8px 0;">
        <span class="pill">${l.date}</span>
        <span class="pill">${l.subject}</span>
        <span class="muted">${escapeHtml(l.task || "ï¼ˆã‚¿ã‚¹ã‚¯åãªã—ï¼‰")}</span>
        <div class="small">+${l.xp}XP / +${l.coin}COIN${mins}</div>
      </div>`;
    }).join("");

    // adventure
    const area = currentArea();
    $("areaName").textContent = area.name;
    $("areaStep").textContent = `æ­©æ•°ï¼š${state.areaStep}/${area.steps}`;
    $("areaBar").style.width = `${Math.min(100, Math.floor((state.areaStep / area.steps) * 100))}%`;

    const areaPanel = $("areaPanel");
    areaPanel.classList.remove("town","forest","cave","tower","castle");
    areaPanel.classList.add(area.key);
    const areaEmoji = { town:"ğŸ˜ï¸", forest:"ğŸŒ²", cave:"ğŸ•¯ï¸", tower:"ğŸ—¼", castle:"ğŸ°" }[area.key] || "ğŸ—ºï¸";
    $("areaIcon").textContent = areaEmoji;

    const titleObj = TITLES.find(t => t.key === state.currentTitleKey) || TITLES[0];
    $("titleName").textContent = titleObj ? titleObj.name : "â€”";
    $("titleHint").textContent = titleObj ? `æ¡ä»¶ï¼š${titleObj.hint}` : "â€”";

    // story (area + title)
    const areaStory = AREA_STORY[area.key] || "â€”";
    const titleStory = TITLE_STORY[state.currentTitleKey] || "â€”";
    if ($("storyArea")) $("storyArea").textContent = areaStory;
    if ($("storyTitle")) $("storyTitle").textContent = titleStory;


    // pet
    petDailyTick();
    $("petName").value = state.pet.name || "ã¾ã£ã•";
    $("petLv").textContent = state.pet.lv;
    $("petBond").textContent = state.pet.bond;
    $("petMoodVal").textContent = state.pet.mood;
    $("petFood").textContent = state.pet.food;
    const ps = petStatusText();
    $("petMood").textContent = ps.mood;
    $("petTalk").textContent = ps.talk;

    updatePetImage();
    console.log("PET MOOD TEXT:", $("petMood")?.textContent);

    // Study log KPIs
    const tk = todayKey();
    const todayM = (state.studyByDate[tk] || 0);
    $("todayMins").textContent = fmtHM(todayM);

    const monday = getMonday(new Date());
    const weekM = getWeekMinutes(monday);
    $("weekMins").textContent = fmtHM(weekM);

    const goal = getWeeklyGoalMinutesForThisWeek();
    $("goalMins").textContent = fmtHM(goal);

    const ratio = goal > 0 ? Math.min(1, weekM / goal) : 0;
    $("weekBar").style.width = `${Math.floor(ratio*100)}%`;

    const remain = Math.max(0, goal - weekM);
    const dLeft = daysLeftInWeekInclusive();
    const need = (goal > 0) ? Math.ceil(remain / dLeft) : 0;
    $("remainMins").textContent = fmtHM(remain);
    $("daysLeft").textContent = dLeft;
    $("needPerDay").textContent = fmtHM(need);

    const wk = weekKeyFromDate(new Date());
    const mondayStr = `${monday.getMonth()+1}/${monday.getDate()}`;
    $("goalPieHint").textContent = `ä»Šé€±ï¼ˆ${mondayStr}é€±ï¼‰ã®ç›®æ¨™ã€‚é€±ã‚­ãƒ¼ï¼š${wk}`;

    $("setWeeklyGoal").disabled = !isMondayLocal();
    $("goalStatus").textContent = isMondayLocal()
      ? "ä»Šæ—¥ã¯æœˆæ›œã€‚ä»Šé€±ã®ç›®æ¨™ã‚’ã‚»ãƒƒãƒˆã§ãã‚‹ã€‚"
      : "ç›®æ¨™ã®è¨­å®šã¯æœˆæ›œã®ã¿ã€‚";

    // âœ… NEW: HOME mini summary
    $("homeTodayMins").textContent = fmtHM(todayM);
    $("homeWeekMins").textContent = fmtHM(weekM);
    $("homeRemainMins").textContent = fmtHM(remain);
    $("homeNeedText").textContent = (goal > 0)
      ? `é€±ç›®æ¨™ ${fmtHM(goal)}ã€‚æ®‹ã‚Š ${fmtHM(remain)}ã€‚æ®‹ã‚Š${dLeft}æ—¥ â†’ 1æ—¥ã‚ãŸã‚Š ${fmtHM(need)} å¿…è¦ã€‚`
      : "é€±ç›®æ¨™ãŒæœªè¨­å®šã€‚æœˆæ›œã«ã‚»ãƒƒãƒˆã™ã‚‹ã¨ã€Œæ®‹ã‚Š/å¿…è¦åˆ†ã€ãŒå‡ºã‚‹ã€‚";

    // charts (only when visible)
    if (state.uiPage === "study") {
      drawStudyChart();
      drawGoalPie();
      drawSubjectPie();
    }
  }

  // ---------- Timer (Work: 25min, then overtime / Break: 5min) ----------
  const WORK_SEC = 25 * 60;
  const BREAK_SEC = 5 * 60;

  // phase: "work" | "break"
  let phase = "work";
  let running = false;
  let tickHandle = null;

  let lastTickMs = 0;         // ç›´è¿‘ã®tickæ™‚åˆ»

  // work tracking (keeps counting after 25:00 â†’ +0:01 â€¦)
  let workElapsedSec = 0;

  // break tracking
  let breakRemainingSec = BREAK_SEC;

  function fmt(sec){
    const m = String(Math.floor(sec/60)).padStart(2,"0");
    const s = String(sec%60).padStart(2,"0");
    return `${m}:${s}`;
  }

  function setTimerUI(){
    if (phase === "work"){
      const remain = Math.max(0, WORK_SEC - workElapsedSec);
      if (remain > 0){
        $("timer").textContent = `ğŸ“š ${fmt(remain)}`;
      } else {
        const over = workElapsedSec - WORK_SEC;
        $("timer").textContent = `ğŸ“š +${fmt(over)}`;
      }
      $("phaseHint") && ($("phaseHint").textContent = "WORK");
      $("skipBreak") && ($("skipBreak").style.display = "none");
    } else {
      $("timer").textContent = `â˜• ${fmt(Math.max(0, breakRemainingSec))}`;
      $("phaseHint") && ($("phaseHint").textContent = "BREAK");
      $("skipBreak") && ($("skipBreak").style.display = "block");
    }
  }

  function startTimer(){
  if (running) return;
  running = true;

  lastTickMs = Date.now();

  tickHandle = setInterval(() => {
    const now = Date.now();
    let deltaSec = Math.floor((now - lastTickMs) / 1000);
    if (deltaSec <= 0) return;

    // æ¬¡ã®åŸºæº–ã‚’æ›´æ–°ï¼ˆä½™ã‚ŠãƒŸãƒªç§’ã¯åˆ‡ã‚Šæ¨ã¦ã§OKï¼‰
    lastTickMs += deltaSec * 1000;

    if (phase === "work"){
      workElapsedSec += deltaSec;
      setTimerUI();
      return;
    }

    // break
    if (breakRemainingSec > 0){
      breakRemainingSec = Math.max(0, breakRemainingSec - deltaSec);
      setTimerUI();

      if (breakRemainingSec === 0){
        running = false;
        clearInterval(tickHandle);
        toWorkPhase(true);
      }
    }
  }, 250); // 1ç§’ã˜ã‚ƒãªãã¦250msã§ååˆ†ï¼ˆå®Ÿæ™‚é–“è¨ˆç®—ãªã®ã§è»½ã„ï¼‰
}

  function pauseTimer(){
  if (!running) return;
  clearInterval(tickHandle);
  running = false;
  lastTickMs = 0;
}

  function toWorkPhase(fromBreakEnd=false){
    phase = "work";
    workElapsedSec = 0;
    setTimerUI();
    if (fromBreakEnd) showReward("ğŸ”¥ ä¼‘æ†©çµ‚äº†ï¼æ¬¡ã®25åˆ†ã„ã“ã†ï¼ˆSTARTï¼‰");
  }

  function toBreakPhase(autoStart=true){
    phase = "break";
    breakRemainingSec = BREAK_SEC;
    setTimerUI();
    showReward("â˜• 5åˆ†ä¼‘æ†©ï¼å¿…è¦ãªã‚‰ã‚¹ã‚­ãƒƒãƒ—ã‚‚ã§ãã‚‹ã‚ˆã€‚");
    if (autoStart){
      // break is supposed to start immediately
      if (running){
        // keep the same interval, it will tick as break next tick
      } else {
        startTimer();
      }
    }
  }

  // Convert workElapsedSec to minutes (rounded to nearest minute, min 1 if >0 sec)
  function workMinutesNow(){
  const sec = Math.max(0, workElapsedSec);
  if (sec === 0) return 0;
  return Math.max(1, Math.floor(sec / 60));
}

  // Done: always records the WORK time so far, then moves to BREAK
  function doneFromButton(){
    if (phase !== "work"){
      showReward("â˜• ã„ã¾ä¼‘æ†©ä¸­ã€‚ã‚¹ã‚­ãƒƒãƒ—ã™ã‚‹ãªã‚‰â­ã‚’æŠ¼ã—ã¦ã­ã€‚");
      return;
    }
    const mins = workMinutesNow();
    doneTask(mins, { auto:false });
    // after recording, go to break
    toBreakPhase(true);
    // reset work counter for next round (starts after break)
    workElapsedSec = 0;
  }

  function skipBreak(){
    if (phase !== "break") return;
    pauseTimer();
    toWorkPhase(false);
    showReward("â­ ä¼‘æ†©ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ãŸã€‚æ¬¡ã„ã“ï¼ˆSTARTï¼‰");
  }

  function resetTimer(){
    pauseTimer();
    phase = "work";
    workElapsedSec = 0;
    breakRemainingSec = BREAK_SEC;
    setTimerUI();
  }


  // ---------- Weekly goal (Monday only) ----------
  function setWeeklyGoal(){
    if (!isMondayLocal()){
      showReward("ğŸ“Œ ç›®æ¨™è¨­å®šã¯æœˆæ›œã®ã¿ã€‚æœˆæ›œã«å›ºå®šã™ã‚‹ä»•æ§˜ã€‚");
      return;
    }
    const hours = parseFloat($("weeklyGoalHours").value);
    if (!Number.isFinite(hours) || hours < 0){
      showReward("âš ï¸ ç›®æ¨™æ™‚é–“ã‚’æ­£ã—ãå…¥åŠ›ã—ã¦ã€‚ä¾‹ï¼š70");
      return;
    }
    const mins = Math.round(hours * 60);
    const wk = weekKeyFromDate(new Date());
    state.weeklyGoalByWeek[wk] = mins;
    persist();
    showReward(`ğŸ“Œ ä»Šé€±ã®ç›®æ¨™ï¼š${fmtHM(mins)}ï¼ˆ${hours}æ™‚é–“ï¼‰ã‚’ã‚»ãƒƒãƒˆã—ãŸ`);
    render();
  }

  // ---------- Done action ----------
  function doneTask(minsOverride, opts){
    opts = opts || {};
    const auto = !!opts.auto;
    const subject = $("subject").value;
    const task = $("task").value.trim();

   // time tracking: count WORK minutes only
let mins = (typeof minsOverride === "number") ? Math.round(minsOverride) : getWorkElapsedMinutes();
mins = Math.max(0, mins);

// ä¼‘æ†©ãƒ•ã‚§ãƒ¼ã‚ºã§æ‰‹å‹•å®Œäº†ã™ã‚‹ã¨0åˆ†ã«ãªã‚ŠãŒã¡ãªã®ã§ã€äºŒé‡è¨ˆä¸Šã‚‚å«ã‚ã¦ã‚¬ãƒ¼ãƒ‰
if (!auto && phase !== "work") {
  if (autoRecordedThisPhase) {
    showReward("âœ… ã•ã£ãã®25åˆ†ã¯è‡ªå‹•ã§è¨˜éŒ²æ¸ˆã¿ã ã‚ˆ");
  } else {
    showReward("â˜• ã„ã¾ä¼‘æ†©ä¸­ã€‚å‹‰å¼·ã«æˆ»ã£ã¦ã‹ã‚‰å®Œäº†ã—ã¦ã­");
  }
  return;
}
if (!auto && mins <= 0) { showReward("â± 0åˆ†ã¯è¨˜éŒ²ã—ãªã„ã‚ˆï¼ˆå°‘ã—ã‚„ã£ã¦ã‹ã‚‰å®Œäº†ã—ã¦ã­ï¼‰"); return; }

addStudyMinutes(todayKey(), mins);

    if (phase === "work") workRecordedThisPhase = true;

    // rewards
    let xp = 25;
    let coin = 10;
    if (subject === "è²¡å‹™" || subject === "ç®¡ç†") coin += 2;
    if (subject === "ä¼æ¥­") xp += 3;
    if (subject === "ç›£æŸ»") xp += 2;

    updateStreakOnDone();

    // streak bonus each 7
    if (state.streak > 0 && state.streak % 7 === 0) {
      coin += 40;
      showReward(`ğŸ”¥ 7æ—¥é€£ç¶šãƒœãƒ¼ãƒŠã‚¹ï¼ +40ã‚³ã‚¤ãƒ³ï¼ˆSTREAK ${state.streak}ï¼‰`);
      pushAdventureLog(`ğŸ”¥ 7æ—¥é€£ç¶šãƒœãƒ¼ãƒŠã‚¹ï¼`);
    }

    gain(xp, coin);

    state.totalCompletions += 1;
    state.bySubject[subject] = (state.bySubject[subject] || 0) + 1;

    // adventure move
    state.areaStep += 1;
    const area = currentArea();
    if (state.areaStep >= area.steps) {
      state.areaIndex = Math.min(state.areaIndex + 1, AREAS.length - 1);
      state.areaStep = 0;

      const newArea = currentArea();
      const e = newArea.onEnter?.() || {};
      if (e.xp) gain(e.xp, 0);
      if (e.coin) gain(0, e.coin);
      if (e.msg) { showReward(e.msg); pushAdventureLog(e.msg); }
      pushAdventureLog(`â¡ï¸ ${newArea.name} ã«åˆ°é”ï¼`);
    }

    // titles unlock
    for (const t of TITLES) {
      const has = state.unlockedTitles.includes(t.key);
      if (!has && t.check(state)) {
        state.unlockedTitles.push(t.key);
        state.currentTitleKey = t.key;

        const r = t.reward || {};
        if (r.xp) gain(r.xp, 0);
        if (r.coin) gain(0, r.coin);
        if (r.msg) { showReward(r.msg); pushAdventureLog(r.msg); }
      }
    }

    // pet react
    let mood = 10, food = 8, bond = 1, pxp = 10;
    if (subject === "è²¡å‹™" || subject === "ç®¡ç†") { mood = 12; food = 10; pxp = 12; }
    if (subject === "ä¼æ¥­") { mood = 8; food = 8; pxp = 10; }
    if (subject === "ç›£æŸ»") { mood = 9; food = 8; pxp = 11; }
    petGain(pxp, bond, mood, food);

    // log
    state.logs.unshift({ date: todayKey(), subject, task, xp, coin, mins });

    resetTimer();
    persist();
    render();
  }

  // ---------- Gacha ----------
  function gacha(){
    if (state.coin < 30) { showReward("ğŸ’¸ ã‚³ã‚¤ãƒ³ä¸è¶³ï¼ï¼ˆ30å¿…è¦ï¼‰"); return; }
    state.coin -= 30;
    const item = gachaPool[Math.floor(Math.random()*gachaPool.length)];
    showReward(`ğŸ ã‚¬ãƒãƒ£çµæœï¼š${item}`);
    pushAdventureLog(`ğŸ ã‚¬ãƒãƒ£ï¼š${item}`);
    persist(); render();
  }

  // ---------- Adventure log toggle ----------
  $("adventureLogBtn").addEventListener("click", () => {
    const box = $("adventureLog");
    const open = box.style.display !== "none";
    box.style.display = open ? "none" : "block";
    if (!open) {
      const lines = (state.adventureLogs || []).slice(0, 20);
      box.innerHTML = lines.length ? lines.map(x => `<div>${escapeHtml(x)}</div>`).join("") : "ï¼ˆã¾ã ãƒ­ã‚°ãŒãªã„ï¼‰";
    }
  });

  // ---------- Export / wipe ----------
  $("exportJson").addEventListener("click", () => {
    const box = $("exportBox");
    box.style.display = "block";
    box.textContent = JSON.stringify(state, null, 2);
    showReward("ğŸ“¤ ãƒ‡ãƒ¼ã‚¿ã‚’æ›¸ãå‡ºã—ãŸï¼ˆä¸‹ã«è¡¨ç¤ºï¼‰");
  });
  $("wipe").addEventListener("click", () => {
    if (!confirm("å…¨ãƒ‡ãƒ¼ã‚¿ã‚’åˆæœŸåŒ–ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ï¼Ÿ")) return;
    localStorage.removeItem(KEY);
    state = defaultState();
    persist();
    setPage("home");
    showReward("ğŸ§¨ åˆæœŸåŒ–ã—ãŸ");
    render();
  });

  // ---------- Pet controls ----------
  $("petName").addEventListener("change", () => {
    state.pet.name = $("petName").value.trim() || "ã¾ã£ã•";
    persist(); render();
  });
  $("petFeed").addEventListener("click", () => {
    if (state.coin < 10) { showReward("ğŸ’¸ ã‚³ã‚¤ãƒ³ä¸è¶³ï¼ï¼ˆãŠã‚„ã¤10ã‚³ã‚¤ãƒ³ï¼‰"); return; }
    state.coin -= 10;
    petGain(0, 1, 10, 18);
    showReward("ğŸ– ãŠã‚„ã¤ï¼ ãƒšãƒƒãƒˆã®æ©Ÿå«ŒãŒå›å¾©ã—ãŸã€‚");
    pushAdventureLog("ğŸ– ãŠã‚„ã¤ã‚’ã‚ã’ãŸ");
    persist(); render();
  });
  $("petPet").addEventListener("click", () => {
    if (state.pet.petsToday >= 3) { showReward("ğŸ˜¼ ãªã§éãã€‚ä»Šæ—¥ã¯ã‚‚ã†ååˆ†ã€‚"); return; }
    state.pet.petsToday += 1;
    petGain(0, 2, 6, 0);
    showReward("ğŸ«³ ãªã§ãŸã€‚ãªã¤ããŒä¸ŠãŒã£ãŸã€‚");
    pushAdventureLog("ğŸ«³ ãªã§ãŸ");
    persist(); render();
  });

  // ---------- Wire up ----------
  $("start").addEventListener("click", startTimer);
  $("pause").addEventListener("click", pauseTimer);
  $("reset").addEventListener("click", resetTimer);
  $("done").addEventListener("click", doneFromButton);
  $("skipBreak").addEventListener("click", skipBreak);
  $("gacha").addEventListener("click", gacha);
  $("save").addEventListener("click", () => { persist(); showReward("ğŸ’¾ ã‚»ãƒ¼ãƒ–ã—ã¾ã—ãŸ"); });
  $("setWeeklyGoal").addEventListener("click", setWeeklyGoal);

// ---- Import ----
const importBtn = $("importBtn");
if (importBtn){
  importBtn.addEventListener("click", () => {
    const raw = ($("importText").value || "").trim();
    if (!raw) { showReward("âš ï¸ JSONãŒç©ºã£ã½"); return; }

    // äº‹æ•…é˜²æ­¢
    if (!confirm("ã“ã®ç«¯æœ«ã®ãƒ‡ãƒ¼ã‚¿ã‚’ä¸Šæ›¸ãã™ã‚‹ã‚ˆã€‚OKï¼Ÿ")) return;

    try{
      const obj = JSON.parse(raw);

      // æœ€ä½é™ã®å‹ãƒã‚§ãƒƒã‚¯ï¼ˆé›‘ã«å¼¾ãï¼‰
      if (!obj || typeof obj !== "object") throw new Error("JSONãŒã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã˜ã‚ƒãªã„");

      // ç§»è¡Œã—ã¦ä¿å­˜
      state = migrate(obj);
      persist();

      showReward("âœ… ã‚¤ãƒ³ãƒãƒ¼ãƒˆå®Œäº†ï¼ãƒ‡ãƒ¼ã‚¿ã‚’åæ˜ ã—ãŸã€‚");
      setPage(state.uiPage || "home");
      render();
    } catch(e){
      showReward("âŒ ã‚¤ãƒ³ãƒãƒ¼ãƒˆå¤±æ•—ï¼šJSONãŒå£Šã‚Œã¦ã‚‹ã‹å½¢å¼ãŒé•ã†");
      console.error(e);
    }
  });
}

// ---- Copy export box ----
const copyBtn = $("copyExport");
if (copyBtn){
  copyBtn.addEventListener("click", async () => {
    try{
      const text = JSON.stringify(state, null, 2);
      await navigator.clipboard.writeText(text);
      showReward("ğŸ“‹ æ›¸ãå‡ºã—JSONã‚’ã‚³ãƒ”ãƒ¼ã—ãŸ");
    } catch(e){
      showReward("âš ï¸ ã‚³ãƒ”ãƒ¼å¤±æ•—ï¼ˆãƒ–ãƒ©ã‚¦ã‚¶åˆ¶é™ã‹ã‚‚ï¼‰ã€‚æ›¸ãå‡ºã—è¡¨ç¤ºã‚’æ‰‹å‹•ã§ã‚³ãƒ”ãƒ¼ã—ã¦ã€‚");
      console.error(e);
    }
  });
}


  // Jump to Study log button (optional)
  if ($("jumpStudy")) {
    $("jumpStudy").addEventListener("click", () => {
      setPage("study");
      render();
    });
  }
// Tabs
  function bindTab(el, page){
    el.addEventListener("click", () => {
      setPage(page);
      render();
    });
  }
  bindTab($("tabHome"), "home");
  bindTab($("tabStudy"), "study");
  bindTab($("tabAdventure"), "adventure");
  bindTab($("tabPet"), "pet");
  bindTab($("tabInfo"), "info");
// Resize charts
  window.addEventListener("resize", () => {
    if (state.uiPage === "study"){
      drawStudyChart();
      drawGoalPie();
      drawSubjectPie();
    }
  });

// ---- Cloud Sync UI ----
const loginBtn = $("loginBtn");
if (loginBtn){
  loginBtn.addEventListener("click", async () => {
    const email = ($("loginEmail")?.value || "").trim();
    await signInWithEmail(email);
  });
}

const signinPassBtn = $("signinPassBtn");
if (signinPassBtn){
  signinPassBtn.addEventListener("click", async () => {
    const email = ($("loginEmail")?.value || "").trim();
    const pass = ($("loginPass")?.value || "");
    await signInWithPassword(email, pass);
  });
}

const signupBtn = $("signupBtn");
if (signupBtn){
  signupBtn.addEventListener("click", async () => {
    const email = ($("loginEmail")?.value || "").trim();
    const pass = ($("loginPass")?.value || "");
    await signUpWithPassword(email, pass);
  });
}

const resetPassBtn = $("resetPassBtn");
if (resetPassBtn){
  resetPassBtn.addEventListener("click", async () => {
    const email = ($("loginEmail")?.value || "").trim();
    await sendPasswordReset(email);
  });
}


const logoutBtn = $("logoutBtn");
if (logoutBtn){
  logoutBtn.addEventListener("click", async () => {
    await signOutCloud();
  });
}

const cloudPullBtn = $("cloudPull");
if (cloudPullBtn){
  cloudPullBtn.addEventListener("click", async () => {
    await cloudPull({ silent:false, force:true });
  });
}

const cloudPushBtn = $("cloudPush");
if (cloudPushBtn){
  cloudPushBtn.addEventListener("click", async () => {
    await cloudPush();
  });
}

const syncToggleBtn = $("syncToggle");
if (syncToggleBtn){
  syncToggleBtn.addEventListener("click", () => {
    syncEnabled = !syncEnabled;
    syncToggleBtn.textContent = syncEnabled ? "ğŸ” è‡ªå‹•åŒæœŸï¼šON" : "â¸ è‡ªå‹•åŒæœŸï¼šOFF";
    showReward(syncEnabled ? "ğŸ” è‡ªå‹•åŒæœŸON" : "â¸ è‡ªå‹•åŒæœŸOFF");
    if (syncEnabled) startAutoPull(); else stopAutoPull();
  });
}

const showSyncHelpBtn = $("showSyncHelp");
if (showSyncHelpBtn){
  showSyncHelpBtn.addEventListener("click", showSyncHelp);
}

// auth state change: update status + pull once
if (sb){
  sb.auth.onAuthStateChange(async (event, session) => {
    if (session?.user){
      setCloudStatus(`ãƒ­ã‚°ã‚¤ãƒ³ä¸­ï¼š${session.user.email}`);
      await cloudPull({ silent:true, force:true });
      startAutoPull();
    } else {
      setCloudStatus("æœªãƒ­ã‚°ã‚¤ãƒ³");
      stopAutoPull();
    }
  });

  // initial status check
  (async () => {
    const user = await getUser();
    if (user){
      setCloudStatus(`ãƒ­ã‚°ã‚¤ãƒ³ä¸­ï¼š${user.email}`);
      await cloudPull({ silent:true, force:true });
      startAutoPull();
    } else {
      setCloudStatus("æœªãƒ­ã‚°ã‚¤ãƒ³");
    }
  })();
} else {
  setCloudStatus("Supabaseæœªè¨­å®šï¼ˆURL/KEYã‚’è²¼ã‚‹ï¼‰");
}

  // init
  setTimerUI();
  updateCountdown();
  setInterval(updateCountdown, 30*1000);

  // restore last tab
  setPage(state.uiPage || "home");
  render();
</script>
</body>
</html>
